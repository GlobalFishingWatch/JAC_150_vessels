---
title: "150_voi_test"
author: "Max Schofield"
date: "2022-10-21"
output:
  html_notebook:
  df_print: default
highlight: pygments
toc: yes
toc_float:
  toc_collapsed: true
toc_depth: 2

editor_options:
  chunk_output_type: inline
---

```{=html}
<style>
body {
text-align: justify}
</style>
```

# Setup

Knitr options 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load R packages 

```{r load packages}
foo <- function(x){
  for( i in x ){
    #  require returns TRUE invisibly if it was able to load package
    if( ! require( i , character.only = TRUE ) ){
      #  If package was not able to be loaded then re-install
      install.packages( i , dependencies = TRUE )
      #  Load package after installing
      require( i , character.only = TRUE )
    }
  }
}

#  Then try/install packages...
foo( c("tidyverse" , "bigrquery" ,"devtools", "DBI","glue", "lubridate", "here", "sf", "extrafont", "patchwork", "terra") )

# get fishwatch r independently 
if (!require("fishwatchr")) {devtools::install_github("GlobalFishingWatch/fishwatchr")}
library(fishwatchr)

```

Establish connection to BigQuery project

```{r con}
con <- DBI::dbConnect(drv = bigrquery::bigquery(), 
                      project = "world-fishing-827", 
                      use_legacy_sql = FALSE)
```

Set commonly used parameters for mapping

```{r}
# define bounding box/area of interest
# bbox <- data.frame(x_min = -8,
#                    x_max = 3,
#                    y_min = 0,
#                    y_max = 7)
# what projection should be used for mapping
best_proj <- fishwatchr::gfw_projections("Equal Earth")$proj_string
# best_proj <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
```


# Establish Vessel of Interest 

Calling the table directly as it is saved due to being a large query

First question is establish how many vessels have the 150 MMSI prefix in total. 

```{r, echo=FALSE}
q_voi_ais <- c("SELECT * FROM `world-fishing-827.scratch_max.raw_AIS_150_mmsi_prefix_2020_2022`")

all_150_ais <- fishwatchr::gfw_query(query = q_voi_ais,
                                 run_query = TRUE, 
                                 con = con)$data
n_distinct(all_150_ais$ssvid)

```

This is querying the raw AIS data and there is `r n_distinct(voi_ais$ssvid)` vessels in total. 


```{r, echo=FALSE}
# outside china gets all 150 vessels AIS outside of China 
outside_chn <- readr::read_file(file = here::here("queries", ".", "outside_CHN.sql"))
outside_chn_ais<- fishwatchr::gfw_query(query = outside_chn,
                                 run_query = TRUE,
                                 con = con)$data

# write.csv(outside_chn_ais, '../data/step1_outside_CHN.csv', row.names = F)

n_distinct(outside_chn_ais$ssvid)

# restrict down to genuine VOI
outside_AIS <- filter(all_150_ais, ssvid %in% c(outside_chn_ais$ssvid))

# get rid of percentage - indicator of gear markers 
per <- filter(outside_AIS, stringr::str_detect(shipname, '\\%'))

# get rid of ending in v - another indicator of gear markers
per_v <- filter(outside_AIS, stringr::str_detect(shipname, 'v$|V$'))

# get rid of ending in NET another indicator of gear markers
per_v_net <- filter(outside_AIS, stringr::str_detect(shipname, 'NET'))

# get rid of - in the name as another indicator of gear markers
per_v_net_dash <- filter(outside_AIS, stringr::str_detect(shipname, '-'))

# remove vessels
no_per_v_net_dash <- outside_AIS %>% filter(!ssvid %in% unique(c(
    per$ssvid, 
    per_v$ssvid,
    per_v_net$ssvid, 
    per_v_net_dash$ssvid)))

# write out data to visaulise
# write.csv(no_per_v_net_dash, '../data/non_gear_outside_CHN.csv', row.names = F)

# write out the discarded datasets to see if any aligns with areas of interest 
# write.csv(per, '../data/150voi_percentage_in_name.csv', row.names = F)
# write.csv(per_v, '../data/150voi_voltage_in_name.csv', row.names = F)
# write.csv(per_v_net, '../data/150voi_net_in_name.csv', row.names = F)
# write.csv(per_v_net_dash, '../data/150voi_dash_in_name.csv', row.names = F)

n_distinct(outside_AIS$ssvid)
n_distinct(no_per_v_net_dash$ssvid)

data <- no_per_v_net_dash[!is.na(no_per_v_net_dash$lat) & !is.na(no_per_v_net_dash$lon) ,]
n_distinct(data$ssvid)

# still missing where a big chunk data drops out 
# check the opposite of the gear query 

likely_gear <- outside_AIS %>% filter(ssvid %in% unique(c(
    per$ssvid, 
    per_v$ssvid,
    per_v_net$ssvid, 
    per_v_net_dash$ssvid)))
# write.csv(likely_gear, '../data/likely_gear.csv', row.names = F)
```

<!-- ```{r, echo=FALSE} -->
<!-- q_voi_segs <- c("SELECT * FROM `world-fishing-827.scratch_max.AIS_segs_150_mmsi_prefix_2021_20Oct2022`") -->

<!-- # these segments should exclude bitflipped data  -->
<!-- segs_150 <- fishwatchr::gfw_query(query = q_voi_segs, -->
<!--                                  run_query = TRUE,  -->
<!--                                  con = con)$data -->

<!-- not_gear_segs <- filter(segs_150, !ssvid %in% c(likely_gear$ssvid)) -->

<!-- # look at vessel numbers in each df  -->
<!-- n_distinct(not_gear_segs$ssvid) -->
<!-- n_distinct(segs_150$ssvid) -->
<!-- n_distinct(data$ssvid) -->


<!-- # write out non-gear segments to see if the data of interest is still there. -->
<!-- not_gear_segs %>% write_csv(here::here("data", ".", paste0("150_non_gear_segs_",str_replace_all(Sys.Date(), '-','_'),".csv"))) -->
<!-- # segments remove too much data -->

<!-- ``` -->

```{r, echo=FALSE}

# still lots of CHN transmissions. Drop them with a lat/lon subset to make sure we don't still have
# exclusively chinese vessels 
# add index to data 
voi <- data %>% mutate(id = seq(1,nrow(data),1))
chn <- voi %>% filter(between(lon, 107, 124) & between(lat, 18, 41))
n_distinct(chn$ssvid)
n_distinct(voi$ssvid)

# remove data points in China. 
look <- voi %>% filter(!id %in% chn$id)
n_distinct(look$ssvid)
# write.csv(look, '../data/outside_chn_v2.csv', row.names = F)

# run more then 10 transmission query to try remove vessels with bitflips out of CHN 
more_then10 <- look %>% group_by(ssvid) %>% summarise(n=n()) %>% filter(n>10)
outside_chn_more_then10 <- look %>% filter(ssvid %in% (more_then10$ssvid))
n_distinct(outside_chn_more_then10$ssvid)


more_then5 <- look %>% group_by(ssvid) %>% summarise(n=n()) %>% filter(n>5)
outside_chn_more_then5 <- look %>% filter(ssvid %in% (more_then5$ssvid))
n_distinct(outside_chn_more_then5$ssvid)


# writing out data. hashed as dfs are large for
######
# outside_chn_more_then10 %>% write.csv(here::here("data", ".", paste0("active_outside_chn_10_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# outside_chn_more_then5 %>% write.csv(here::here("data", ".", paste0("active_outside_chn_5_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# look %>% filter(!ssvid %in% (outside_chn_more_then10$ssvid))%>% write.csv(here::here("data", ".", paste0("dropped_outside_chn_10_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# look %>% filter(!ssvid %in% (outside_chn_more_then5$ssvid)) %>% write.csv(here::here("data", ".", paste0("dropped_outside_chn_5_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# 

drp_5 <- look %>% filter(!ssvid %in% (outside_chn_more_then5$ssvid))
View(drp_5 %>% group_by(ssvid) %>% summarise(n=n()))
# pattern with 15040 being in our fleet of interest. 


more_then10_int <- look %>% group_by(ssvid) %>% summarise(n=n()) %>% filter(n>10 | str_detect(ssvid, "^15040"))

working_df <- filter(data, ssvid %in% more_then10_int$ssvid)

working_df$year  <- year(working_df$timestamp) 
working_df$month  <- month(working_df$timestamp) 
#working_df %>% write.csv(here::here("data", ".", paste0("150_voi_working_df_",str_replace_all(Sys.Date(), '-','_'),".csv")))
filter(working_df, year == '2020') %>% write.csv(here::here("data", ".", paste0("150_voi_working_df_2020_",str_replace_all(Sys.Date(), '-','_'),".csv")))
filter(working_df, year == '2021') %>% write.csv(here::here("data", ".", paste0("150_voi_working_df_2021_",str_replace_all(Sys.Date(), '-','_'),".csv")))
filter(working_df, year == '2022') %>% write.csv(here::here("data", ".", paste0("150_voi_working_df_2022_",str_replace_all(Sys.Date(), '-','_'),".csv")))


table(filter(data, str_detect(ssvid, "^15040"))$shipname)
table(working_df$shipname)

match_ves <- working_df %>% 
    group_by(ssvid) %>% 
      summarise(positions = n(), 
                names = paste(unique(shipname), collapse="; "), 
                first_timestamp = min(timestamp), 
                last_timestamp = max(timestamp), 
                timespan = difftime(last_timestamp, first_timestamp, units="days")) %>%
        arrange(desc(positions))
              
View(match_ves)

match_ves %>% write.csv(here::here("data", ".", paste0("150_voi_usage_spire_",str_replace_all(Sys.Date(), '-','_'),".csv")))

# write it out to visaulise
# write.csv(outside_chn_more_then10, '../data/active_outside_chn.csv', row.names = F)


# # look at data dropped by the more then 10 criteria 
# removed <- data %>% filter(!ssvid %in% (more_then10$ssvid))
# write.csv(removed, '../data/removed.csv', row.names = F)
# check_ids <-  removed %>% group_by(ssvid) %>% summarise(trans=n()) %>% filter(trans>10)
# 
# check <- filter(removed,  ssvid %in% check_ids$ssvid)
# write.csv(check, '../data/check.csv', row.names = F)
# # working as expected


# filter the whole dataset to only retain the active outside of china vessels (with their china transmissions)
focal <- all_150_ais %>% filter(ssvid %in% unique(outside_chn_more_then10$ssvid)) 
focal <- focal[!is.na(focal$lat) & !is.na(focal$lon) ,]
# focal <- voi_ais %>% filter(ssvid %in% unique(active_outside_chn$ssvid)) 
# write.csv(focal, '../data/all_ais_150_active.csv', row.names = F)

# voi %>% group_by(ssvid) %>% arrange(ssvid, timestamp) %>% mutate(time = difftime(timestamp, lag(timestamp)))

# aggregate the data to rasterfy on map, need fields lat, lon, timestamp, ssvid, and a value to work with 
# map_df <- focal %>% mutate(lat_bin = round(lat, 1), lon_bin = round(lon, 1)) %>% 
#   group_by(ssvid, timestamp, lat_bin, lon_bin) %>%
#     summarise(positions = n(), 
#               vessels = n_distinct(ssvid))
# 
# map_df %>%
#   bigrquery::bq_table_upload(x = bigrquery::bq_table(project = "world-fishing-827",
#                                                    dataset = "scratch_max",
#                                                    table = "150_voi_from_R"),
#                             values = .)
# GFW map query
# SELECT
# CAST(ssvid AS STRING) AS id,
# timestamp,
# lat_bin AS lat,
# lon_bin AS lon,
# CAST(positions AS FLOAT64)AS value,
# FROM `world-fishing-827.scratch_max.150_voi_from_R`
```
```{r, echo=FALSE}
# Need to add class B element 

match_ves <- working_df %>% group_by(ssvid) %>% 
  summarise(positions = n(), names = paste(unique(shipname), collapse="; ")) %>%
    arrange(desc(positions))

write.csv(match_ves, "./data/150_vessels_identity.csv")
```

Of the `r n_distinct(voi_ais$ssvid)` total MMSIs associated with the 150 prefix,  `r n_distinct(outside_chn_vessels$ssvid)` transmitted outside the Chinese EEZ. 

Of the MMSIs operating outside China many have names which indicated they are associated 
with likely fishing gear. MMSIs associated with likely gear was removed from our vessel
of interest list based on removing MMSIs either transmitting a %, a Voltage indicator (V), 
the word 'NET' in the shipname, which are indicators of fishing gear. 

This filtering removed `r n_distinct(outside_AIS$ssvid) - n_distinct(no_per_v_net_dash$ssvid)`
MMSIs from our fleet of interest. Resulting in `r n_distinct(no_per_v_net_dash$ssvid)` remaining 
in our vessels of interest. 

Further filtering was conducted on vessels with less than 10 AIS transmissions between 2021 and 2022 which removed `r n_distinct(outside_AIS$ssvid) - n_distinct(more_then10$ssvid)` vessel from the analysis fleet leaving `n_distinct(more_then10$ssvid)` vessels. 

# Patterns in remaining vessel names  

```{r, echo=FALSE}
ssvids <- working_df %>% filter(str_detect(shipname, '20'))
View(working_df %>% filter(ssvid %in% unique(ssvids$ssvid)) %>% group_by(ssvid) %>% summarise(names=paste(unique(shipname), collapse=" ")))


paste0("('",paste(unique(working_df$ssvid), collapse="','"), "')")

voi_identity_q <- c("
  SELECT 
    ssvid, 
    ais_identity.n_shipname_mostcommon.value AS best_shipname_AIS,
    ais_identity.n_callsign_mostcommon.value AS best_callsign_AIS,
    ais_identity.n_imo_mostcommon.value AS best_imo_AIS,
    registry_info.best_known_shipname, 
    registry_info.best_known_callsign,
    registry_info.best_known_imo,
    registry_info.best_known_flag,
    registry_info.best_known_vessel_class,
    best.best_flag, 
    best.best_vessel_class, 
    on_fishing_list_known, 
    on_fishing_list_nn
  FROM `gfw_research.vi_ssvid_v20230101`
  WHERE   
  ssvid IN {voi}
  ")

voi_identity <- fishwatchr::gfw_query(query = glue::glue(voi_identity_q,
                                               voi = paste0("('",paste(unique(working_df$ssvid), collapse="','"), "')")),
                                 run_query = TRUE,
                                 con = con)$data

View(voi_identity)

# explore individual mmsis
table(filter(working_df, ssvid == '412331282')$shipname)
table(filter(working_df, str_detect(shipname, 'SHUN HANG 6'))$ssvid)
table(filter(working_df, str_detect(shipname, 'SHUN'))$shipname)


voi_gfw_names_q <- c("
  SELECT 
    ssvid, 
    shipname.count AS frequency, 
    shipname.value AS shipname
  FROM `gfw_research.vi_ssvid_v20230101`
  LEFT JOIN UNNEST(ais_identity.shipname) AS shipname
  WHERE   
  ssvid IN {voi}
  ")

voi_names <- fishwatchr::gfw_query(query = glue::glue(voi_gfw_names_q,
                                               voi = paste0("('",paste(unique(working_df$ssvid), collapse="','"), "')")),
                                 run_query = TRUE,
                                 con = con)$data
getwd()
write.csv(voi_identity, "../data/150_voi_names_frequency.csv")
  
```


```{r, echo=FALSE}
names_df <- focal %>% group_by(ssvid) %>% summarise(names = n_distinct(shipname), 
                                        callsigns = n_distinct(shipname)) #%>% group_by(names) %>% 
    #summarise(freq = n())

ggplot(names_df) +
  geom_histogram(aes(x=names)) +
  labs(x='Number of Names', y='Number of Vessels')+
  theme_gfw()+
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), 
        axis.text=element_text(size=11), axis.title=element_text(size=12,face="bold"), 
        legend.title=element_text(size=12), legend.text=element_text(size=11)) 

table(focal$shipname)

# zhe <- filter(focal, stringr::str_detect(shipname, '^ZHESHENG'))
# write.csv(zhe, '../data/zhe.csv', row.names = F)
# w150 <- filter(focal, shipname== 'W150100801')
# write.csv(w150, '../data/w150.csv', row.names = F)



```

The vessel of interest have five distinct vessel name groupings within them
1. names starting with FU of which there are `r n_distinct(filter(voi_ais, stringr::str_starts(shipname, 'FU'))$shipname)` distinct names with FU YUAN YU ... the most common pattern
2. names starting with HAI of which there are `r n_distinct(filter(voi_ais, stringr::str_starts(shipname, 'HAI'))$shipname)` distinct names with HAI YANG ... the most common pattern
3. names starting with LU RONG which there are `r n_distinct(filter(voi_ais, stringr::str_starts(shipname, 'LU'))$shipname)` distinct names with LURONG YUAN YU ... the most common pattern
4. names starting with SHUN HANG which there are `r n_distinct(filter(voi_ais, stringr::str_starts(shipname, 'SHUN'))$shipname)` distinct names following this pattern. This aligns with SHUN HANG which are an AIS unit manufacturer and may relate to units being reset.

One further vessel had the name LU QING YUAN YU 290. Only one MMSI transmitted this vessel name. 

Clear vessel names with some iterations in the dataset
- FU YUAN YU 715
- FU YUAN YU 717
- FU YUAN YU 9993
- FU YUAN YU 9994
- HAI HANG 1 
- HAI HANG 2
- HAI HANG 3
- HAI HANG 5
- HAI HANG 6 
- LU QING YUAN YU 290
- LU RONG YUAN YU 195 
- LU RONG YUAN YU 581 
- LU RONG YUAN YU 715 
- LU RONG YUAN YU 197 
- LU RONG YUAN YU 20 
- LU RONG YUAN YU 277 
- LU RONG YUAN YU 278 
- LU RONG YUAN YU 717 
- LU RONG YUAN YU 715 
- SHUN HANG 1 
- SHUN HANG 2
- SHUN HANG 3
- SHUN HANG 5
- SHUN HANG 6


# How many vessels have links to China through location   

Three MMSI transmitted positions within the Chinese EEZ. This may point to vessel 
changing to official MMSI to enter the Chinese EEZ.  


Now lets try plot out some of this effort data to share with JAC partners 

```{r warning=FALSE}
# lets aggregate the data to lat/lon bins to use fishwatchr example mapping code 
voi_ais$lat_bin <- round(voi_ais$lat,1)
voi_ais$lon_bin <- round(voi_ais$lon,1)

presence <- voi_ais %>%
  group_by(lat_bin, lon_bin) %>%
    summarise(
      positions = n(), 
    )

  presence %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'positions',
                  center = -80) %>%
  ggplot() +
  geom_raster(aes(x = lon_bin,
                  y = lat_bin,
                  fill = positions)) +
  geom_gfw_land(theme = 'light', center = -80) +
  geom_gfw_eez(theme = 'light', center = -80, alpha = 0.05) +
  scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                       limits = c(0,10000),
                       oob = scales::squish,
                       na.value = NA) +
  labs(fill = 'AIS Positions') +
  theme_gfw_map(theme = 'light')

ggsave(here::here("outputs", "figures", "voi_ais_map.png"))

```


Save the data in the repo to save pulling from big query each time 
```{r}
voi_ais %>% write_csv(here::here("data", ".", "voi_ais.csv"))
voi_ais %>% saveRDS(here::here("data", ".", "voi_ais.rds"))
f_eff <- read_rds(here::here("data", ".", "voi_ais.rds"))
```

Now test out a regional map with machine learning derived fishing events 

```{r, echo=F}
mmsi_412331284 <- c("
SELECT 
  * 
FROM `world-fishing-827.pipe_production_v20201001.messages_segmented_20221111`
WHERE 
  ssvid = '412331284' AND 
  DATE(timestamp) BETWEEN '2020-11-01' AND DATE(CURRENT_DATE())")


mmsi_412331284_ais <- fishwatchr::gfw_query(query = mmsi_412331284,
                                 run_query = TRUE, 
                                 con = con)$data
head(mmsi_412331284_ais)

mmsi_412331284_ais$regions[1]$eez


out_dat <- dplyr::select(mmsi_412331284_ais, source, type, ssvid, timestamp, 
                        lon, lat, speed, course, heading, shipname, callsign, 
                        destination, imo, shiptype, receiver_type, receiver, 
                        length, width, status)
write.csv(out_dat, 'LRYY715 412331284.csv', row.names = F)

mmsi_150400453 <- c("
SELECT 
  * 
FROM `world-fishing-827.pipe_production_v20201001.messages_scored_20221111`
WHERE 
  ssvid = '150400453' AND 
  DATE(timestamp) BETWEEN '2020-11-01' AND DATE(CURRENT_DATE())")


mmsi_150400453_ais  <- fishwatchr::gfw_query(query = mmsi_150400453,
                                 run_query = TRUE, 
                                 con = con)$data
head(mmsi_150400453_ais)


out_dat2 <- dplyr::select(mmsi_150400453_ais, source, type, ssvid, timestamp, 
                        lon, lat, speed, course, heading, shipname, callsign, 
                        destination, imo, shiptype, receiver_type, receiver, 
                        length, width, status)
write.csv(out_dat2, 'LRYY715 150400453.csv', row.names = F)

```

