---
title: "150_voi_test"
author: "Max Schofield"
date: "2022-10-21"
output:
  html_notebook:
  df_print: default
highlight: pygments
toc: yes
toc_float:
  toc_collapsed: true
toc_depth: 2

editor_options:
  chunk_output_type: inline
---

```{=html}
<style>
body {
text-align: justify}
</style>
```

# Setup

Knitr options 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load R packages 

```{r load packages}
foo <- function(x){
  for( i in x ){
    #  require returns TRUE invisibly if it was able to load package
    if( ! require( i , character.only = TRUE ) ){
      #  If package was not able to be loaded then re-install
      install.packages( i , dependencies = TRUE )
      #  Load package after installing
      require( i , character.only = TRUE )
    }
  }
}

#  Then try/install packages...
foo( c("tidyverse" , "bigrquery" ,"devtools", "DBI","glue", "lubridate", "here", "sf", "extrafont", "patchwork", "terra", "rgeos") )

# get fishwatch r independently 
if (!require("fishwatchr")) {devtools::install_github("GlobalFishingWatch/fishwatchr")}
library(fishwatchr)

if (!require("extrafont"))
  install.packages("extrafont")

# Unfortunately `extrafont::font_import()` will fail on latest Rttf2pt1 package...
# so we need to install old version
devtools::install_version("Rttf2pt1", version = "1.3.8")

# Import fonts to R
# This will take few minutes
extrafont::font_import()

# remove a package causing issues 
#detach("package:plyr", unload=TRUE)
```

Establish connection to BigQuery project

```{r con}
con <- DBI::dbConnect(drv = bigrquery::bigquery(), 
                      project = "world-fishing-827", 
                      use_legacy_sql = FALSE)
```

Set commonly used parameters for mapping

```{r}
# define bounding box/area of interest
# bbox <- data.frame(x_min = -8,
#                    x_max = 3,
#                    y_min = 0,
#                    y_max = 7)
# what projection should be used for mapping
best_proj <- fishwatchr::gfw_projections("Equal Earth")$proj_string
# best_proj <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
```


# Establish Vessel of Interest 

Calling the table directly as it is saved due to being a large query

First question is establish how many vessels have the 150 MMSI prefix in total. 

```{r, echo=FALSE}
# q_voi_ais <- c("SELECT * FROM `world-fishing-827.scratch_max.raw_AIS_150_mmsi_prefix_2020_2022`")
# 
# all_150_ais <- fishwatchr::gfw_query(query = q_voi_ais,
#                                  run_query = TRUE, 
#                                  con = con)$data
# n_distinct(all_150_ais$ssvid)
# 
# all_150_ais %>% saveRDS(here::here("data", ".", "all_150_ais.rds"))
all_150_ais <- read_rds(here::here("data", ".", "all_150_ais.rds"))

```

This is querying the raw AIS data and there is `r n_distinct(voi_ais$ssvid)` vessels in total. 

# Remove gear from 150 vessels  

Chunk trys to identify gear and has code to write out gear datasets (hashed as these are large dfs!)

```{r, echo=FALSE}
# outside china gets all 150 vessels AIS outside of China 
#outside_chn <- readr::read_file(file = here::here("queries", ".", "outside_CHN.sql"))
#outside_chn_ais<- fishwatchr::gfw_query(query = outside_chn,
#                                 run_query = TRUE,
#                                 con = con)$data
#
#outside_chn_ais %>% saveRDS(here::here("data", ".", "outside_chn_ais.rds"))
outside_chn_ais <- read_rds(here::here("data", ".", "outside_chn_ais.rds"))


# write.csv(outside_chn_ais, '../data/step1_outside_CHN.csv', row.names = F)

n_distinct(outside_chn_ais$ssvid)

# restrict down to genuine VOI
outside_AIS <- filter(all_150_ais, ssvid %in% c(outside_chn_ais$ssvid))

# get rid of percentage - indicator of gear markers 
per <- filter(outside_AIS, stringr::str_detect(shipname, '\\%'))

# get rid of ending in v - another indicator of gear markers
per_v <- filter(outside_AIS, stringr::str_detect(shipname, 'v$|V$'))

# get rid of ending in NET another indicator of gear markers
per_v_net <- filter(outside_AIS, stringr::str_detect(shipname, 'NET'))

# get rid of - in the name as another indicator of gear markers
per_v_net_dash <- filter(outside_AIS, stringr::str_detect(shipname, '-'))

# remove vessels
no_per_v_net_dash <- outside_AIS %>% filter(!ssvid %in% unique(c(
    per$ssvid, 
    per_v$ssvid,
    per_v_net$ssvid, 
    per_v_net_dash$ssvid)))

# write out data to visaulise
# write.csv(no_per_v_net_dash, '../data/non_gear_outside_CHN.csv', row.names = F)

# write out the discarded datasets to see if any aligns with areas of interest 
# write.csv(per, '../data/150voi_percentage_in_name.csv', row.names = F)
# write.csv(per_v, '../data/150voi_voltage_in_name.csv', row.names = F)
# write.csv(per_v_net, '../data/150voi_net_in_name.csv', row.names = F)
# write.csv(per_v_net_dash, '../data/150voi_dash_in_name.csv', row.names = F)

n_distinct(outside_AIS$ssvid)
n_distinct(no_per_v_net_dash$ssvid)

data <- no_per_v_net_dash[!is.na(no_per_v_net_dash$lat) & !is.na(no_per_v_net_dash$lon) ,]
n_distinct(data$ssvid)

# still missing where a big chunk data drops out 
# check the opposite of the gear query 

likely_gear <- outside_AIS %>% filter(ssvid %in% unique(c(
    per$ssvid, 
    per_v$ssvid,
    per_v_net$ssvid, 
    per_v_net_dash$ssvid)))
# write.csv(likely_gear, '../data/likely_gear.csv', row.names = F)
```

# Look at activity outside of China

Lots of the activity and ssvids are only active in the Chinese EEZ, this activity is 
unrelated to the activity of interest in existing JAC intreps and should be removed. 

The code also looks at setting a limit on minimum number of points outside of China 
to try and remove vessels active in the Chinese EEZ with a number of positional 
anomalies outside of this location. 

```{r, echo=FALSE}

# still lots of CHN transmissions. Drop them with a lat/lon subset to make sure we don't still have
# exclusively chinese vessels 
# add index to data 
voi <- data %>% mutate(id = seq(1,nrow(data),1))
chn <- voi %>% filter(between(lon, 107, 124) & between(lat, 18, 41))
n_distinct(chn$ssvid)
n_distinct(voi$ssvid)

# remove data points in China. 
look <- voi %>% filter(!id %in% chn$id)
n_distinct(look$ssvid)
# write.csv(look, '../data/outside_chn_v2.csv', row.names = F)

# run more then 10 transmission query to  remove vessels with bitflips out of CHN 
more_then10 <- look %>% group_by(ssvid) %>% summarise(n=n()) %>% filter(n>10)
outside_chn_more_then10 <- look %>% filter(ssvid %in% (more_then10$ssvid))
n_distinct(outside_chn_more_then10$ssvid)

# run more then 5 transmission query to  remove vessels with bitflips out of CHN 
more_then5 <- look %>% group_by(ssvid) %>% summarise(n=n()) %>% filter(n>5)
outside_chn_more_then5 <- look %>% filter(ssvid %in% (more_then5$ssvid))
n_distinct(outside_chn_more_then5$ssvid)


# writing out data. hashed as dfs are large for
######
# outside_chn_more_then10 %>% write.csv(here::here("data", ".", paste0("active_outside_chn_10_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# outside_chn_more_then5 %>% write.csv(here::here("data", ".", paste0("active_outside_chn_5_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# look %>% filter(!ssvid %in% (outside_chn_more_then10$ssvid))%>% write.csv(here::here("data", ".", paste0("dropped_outside_chn_10_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# look %>% filter(!ssvid %in% (outside_chn_more_then5$ssvid)) %>% write.csv(here::here("data", ".", paste0("dropped_outside_chn_5_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# 

drp_5 <- look %>% filter(!ssvid %in% (outside_chn_more_then5$ssvid))
#View(drp_5 %>% group_by(ssvid) %>% summarise(n=n()))
# pattern with 15040 being in our fleet of interest. 

# # look at data dropped by the more then 10 criteria 
# removed <- data %>% filter(!ssvid %in% (more_then10$ssvid))
# write.csv(removed, '../data/removed.csv', row.names = F)
# check_ids <-  removed %>% group_by(ssvid) %>% summarise(trans=n()) %>% filter(trans>10)
# 
# check <- filter(removed,  ssvid %in% check_ids$ssvid)
# write.csv(check, '../data/check.csv', row.names = F)
# # working as expected
# write it out to visaulise
# write.csv(outside_chn_more_then10, '../data/active_outside_chn.csv', row.names = F)

# create more then 10 threshold
more_then10_int <- look %>% group_by(ssvid) %>% summarise(n=n()) %>% filter(n>10 | str_detect(ssvid, "^15040"))

# create new working df with vessels with >10 transmissions not thought to be gear 
working_df <- filter(data, ssvid %in% more_then10_int$ssvid)

# look to see is 15040 is the vessel of interest 
table(filter(data, str_detect(ssvid, "^15040"))$shipname)
table(working_df$shipname)

# collate some information on vessels of interest dataset
match_ves <- working_df %>% 
    group_by(ssvid) %>% 
      summarise(positions = n(), 
                names = paste(unique(shipname), collapse="; "), 
                first_timestamp = min(timestamp), 
                last_timestamp = max(timestamp), 
                timespan = difftime(last_timestamp, first_timestamp, units="days")) %>%
        arrange(desc(positions))
              
#View(match_ves)

# write out df 
#match_ves %>% write.csv(here::here("data", ".", paste0("150_voi_usage_spire_",str_replace_all(Sys.Date(), '-','_'),".csv")))

# filter the whole dataset to only retain the active outside of china vessels (with their china transmissions)
focal <- all_150_ais %>% filter(ssvid %in% unique(outside_chn_more_then10$ssvid)) 
focal <- focal[!is.na(focal$lat) & !is.na(focal$lon) ,]
# focal <- voi_ais %>% filter(ssvid %in% unique(active_outside_chn$ssvid)) 
# write.csv(focal, '../data/all_ais_150_active.csv', row.names = F)

# voi %>% group_by(ssvid) %>% arrange(ssvid, timestamp) %>% mutate(time = difftime(timestamp, lag(timestamp)))

```

Of the `r n_distinct(voi_ais$ssvid)` total MMSIs associated with the 150 prefix,  `r n_distinct(outside_chn_vessels$ssvid)` transmitted outside the Chinese EEZ. 

Of the MMSIs operating outside China many have names which indicated they are associated 
with likely fishing gear. MMSIs associated with likely gear was removed from our vessel
of interest list based on removing MMSIs either transmitting a %, a Voltage indicator (V), 
the word 'NET' in the shipname, which are indicators of fishing gear. 

This filtering removed `r n_distinct(outside_AIS$ssvid) - n_distinct(no_per_v_net_dash$ssvid)`
MMSIs from our fleet of interest. Resulting in `r n_distinct(no_per_v_net_dash$ssvid)` remaining 
in our vessels of interest. 

Further filtering was conducted on vessels with less than 10 AIS transmissions between 2021 and 2022 which removed `r n_distinct(outside_AIS$ssvid) - n_distinct(more_then10$ssvid)` vessel from the analysis fleet leaving `n_distinct(more_then10$ssvid)` vessels. 

# Patterns in remaining vessel names  

```{r, echo=FALSE}
# investigate patterns in shipnames 
#ssvids <- working_df %>% filter(str_detect(shipname, '20'))
#View(working_df %>% filter(ssvid %in% unique(ssvids$ssvid)) %>% group_by(ssvid) %>% summarise(names=paste(unique(shipname), collapse=" ")))

# test voi field 
paste0("('",paste(unique(working_df$ssvid), collapse="','"), "')")

# query to investigate identity data from vi_ssvid table 
voi_identity_q <- c("
  SELECT 
    ssvid, 
    ais_identity.n_shipname_mostcommon.value AS best_shipname_AIS,
    ais_identity.n_callsign_mostcommon.value AS best_callsign_AIS,
    ais_identity.n_imo_mostcommon.value AS best_imo_AIS,
    registry_info.best_known_shipname, 
    registry_info.best_known_callsign,
    registry_info.best_known_imo,
    registry_info.best_known_flag,
    registry_info.best_known_vessel_class,
    best.best_flag, 
    best.best_vessel_class, 
    on_fishing_list_known, 
    on_fishing_list_nn
  FROM `gfw_research.vi_ssvid_v20230101`
  WHERE   
  ssvid IN {voi}
  ")

# run query for specified voi - in this case the whole working df 
voi_identity <- fishwatchr::gfw_query(query = glue::glue(voi_identity_q,
                                               voi = paste0("('",paste(unique(working_df$ssvid), collapse="','"), "')")),
                                 run_query = TRUE,
                                 con = con)$data

View(voi_identity)

# explore individual mmsis
table(filter(working_df, ssvid == '412331282')$shipname)
table(filter(working_df, str_detect(shipname, 'SHUN HANG 6'))$ssvid)
table(filter(working_df, str_detect(shipname, 'SHUN'))$shipname)

# look at the frequency of different shipname usage 
voi_gfw_names_q <- c("
  SELECT 
    ssvid, 
    shipname.count AS frequency, 
    shipname.value AS shipname
  FROM `gfw_research.vi_ssvid_v20230101`
  LEFT JOIN UNNEST(ais_identity.shipname) AS shipname
  WHERE   
  ssvid IN {voi}
  ")

voi_names <- fishwatchr::gfw_query(query = glue::glue(voi_gfw_names_q,
                                               voi = paste0("('",paste(unique(working_df$ssvid), collapse="','"), "')")),
                                 run_query = TRUE,
                                 con = con)$data
getwd()
#write.csv(voi_identity, "../data/150_voi_names_frequency.csv")
  
```


```{r, echo=FALSE}
# look at the prevelance of using multiple names 
names_df <- focal %>% group_by(ssvid) %>% summarise(names = n_distinct(shipname), 
                                        callsigns = n_distinct(shipname)) #%>% group_by(names) %>% 
# plot this out 
ggplot(names_df) +
  geom_histogram(aes(x=names)) +
  labs(x='Number of Names', y='Number of Vessels')+
  theme_gfw()+
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), 
        axis.text=element_text(size=11), axis.title=element_text(size=12,face="bold"), 
        legend.title=element_text(size=12), legend.text=element_text(size=11)) 

#table(focal$shipname)

```

 <span style="color:red">Note this text summary is deprecated with more recent analysis done by El which will be the basis of the research report</span>

The vessel of interest have five distinct vessel name groupings within them
1. names starting with FU of which there are `r n_distinct(filter(voi_ais, stringr::str_starts(shipname, 'FU'))$shipname)` distinct names with FU YUAN YU ... the most common pattern
2. names starting with HAI of which there are `r n_distinct(filter(voi_ais, stringr::str_starts(shipname, 'HAI'))$shipname)` distinct names with HAI YANG ... the most common pattern
3. names starting with LU RONG which there are `r n_distinct(filter(voi_ais, stringr::str_starts(shipname, 'LU'))$shipname)` distinct names with LURONG YUAN YU ... the most common pattern
4. names starting with SHUN HANG which there are `r n_distinct(filter(voi_ais, stringr::str_starts(shipname, 'SHUN'))$shipname)` distinct names following this pattern. This aligns with SHUN HANG which are an AIS unit manufacturer and may relate to units being reset.

One further vessel had the name LU QING YUAN YU 290. Only one MMSI transmitted this vessel name. 

Clear vessel names with some iterations in the dataset
- FU YUAN YU 715
- FU YUAN YU 717
- FU YUAN YU 9993
- FU YUAN YU 9994
- HAI HANG 1 
- HAI HANG 2
- HAI HANG 3
- HAI HANG 5
- HAI HANG 6 
- LU QING YUAN YU 290
- LU RONG YUAN YU 195 
- LU RONG YUAN YU 581 
- LU RONG YUAN YU 715 
- LU RONG YUAN YU 197 
- LU RONG YUAN YU 20 
- LU RONG YUAN YU 277 
- LU RONG YUAN YU 278 
- LU RONG YUAN YU 717 
- LU RONG YUAN YU 715 
- SHUN HANG 1 
- SHUN HANG 2
- SHUN HANG 3
- SHUN HANG 5
- SHUN HANG 6

# Established voi list 
```{r, echo=FALSE}
# Read in agreed 225 voi with TMT 

q_voi_est <- c("SELECT * FROM `world-fishing-827.scratch_max.150_voi_ssvid`")

voi_est <- fishwatchr::gfw_query(query = q_voi_est,
                                 run_query = TRUE, 
                                 con = con)$data
```

## Location

# Location in space and time

Look at the consistency of location and fleet size through space and time.

```{r, echo=FALSE}
working_df$year  <- year(working_df$timestamp) 
working_df$month  <- month(working_df$timestamp) 
#working_df %>% write.csv(here::here("data", ".", paste0("150_voi_working_df_",str_replace_all(Sys.Date(), '-','_'),".csv")))

# write out annual dfs to visaulise location and timing in QGIS
# filter(working_df, year == '2020') %>% write.csv(here::here("data", ".", paste0("150_voi_working_df_2020_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# filter(working_df, year == '2021') %>% write.csv(here::here("data", ".", paste0("150_voi_working_df_2021_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# filter(working_df, year == '2022') %>% write.csv(here::here("data", ".", paste0("150_voi_working_df_2022_",str_replace_all(Sys.Date(), '-','_'),".csv")))



```

Map

```{r, echo=FALSE}

# lets aggregate the data to lat/lon bins to use fishwatchr example mapping code 
working_df$lat_bin <- round(working_df$lat/0.5)*0.5
working_df$lon_bin <- round(working_df$lon/0.5)*0.5

# count positions in each lat lon bin
presence <- working_df %>%
  group_by(lat_bin, lon_bin) %>%
    summarise(
      positions = dplyr::n(), 
    )

# set upper limit
up_lim <- 5000 
new_center <- -80
# reset poistions 
#presence$positions[presence$positions>up_lim] <- up_lim

  presence %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'positions',
                  center = new_center) %>%
  ggplot() +
  geom_gfw_outline(center = new_center, 
               theme = "dark") +
  geom_raster(aes(x = lon_bin,
                  y = lat_bin,
                  fill = positions)) +
  geom_gfw_land(theme = 'dark', center = new_center) +
  geom_gfw_eez(theme = 'dark', center = new_center, alpha = 0.2) +
  scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                       limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +
  labs(fill = 'AIS Positions') +
  theme_gfw_map(theme = 'light')

ggsave(here::here("outputs", "figures", "voi_ais_map_0.5deg_global_dark.png"))

```
Pacific Map - note not currently working to transform raster to Pacific view 

```{r, echo=FALSE, warning=F}

# lets aggregate the data to lat/lon bins to use fishwatchr example mapping code 
res <- 0.5
working_df$lat_bin <- round(working_df$lat / res) * res
working_df$lon_bin <- round(working_df$lon / res) * res

# count positions in each lat lon bin
presence <- working_df %>%
  group_by(lat_bin, lon_bin) %>%
    summarise(
      positions = dplyr::n(), 
    )

# set upper limit
up_lim <- 10000 
#set plot center 
new_center <- -90

# set proj for bounding box
best_proj <- "+proj=eqearth +lon_0=-90 +wktext"

# set plot limits for Pacific 
bounding_pacific <- transform_box(xlim = c(-120, -70),
                          ylim = c(10, -55),
                          output_crs = best_proj)
  
pacific_map <- presence %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'positions',
                  center = new_center) %>% 
  ggplot()+
  geom_gfw_outline(center = new_center, theme = "dark") +
  geom_raster(aes(x= lon_bin, y=lat_bin, fill = positions)) +
    geom_gfw_eez(theme = 'dark', alpha = 0.2, center = new_center) +
    geom_gfw_land(theme = 'dark', center = new_center) +
    scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                       limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +   
    coord_sf(xlim = c(bounding_pacific$box_out[['xmin']], bounding_pacific$box_out[['xmax']]),
           ylim = c(bounding_pacific$box_out[['ymin']], bounding_pacific$box_out[['ymax']]),
           crs = bounding_pacific$out_crs) +
    labs(fill = 'AIS Positions') +
      theme_gfw_map(theme = 'light') 


fishwatchr::add_little_globe(pacific_map,
                             main_box = bounding_pacific,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperright')  
  
  
ggsave(here::here("outputs", "figures", "voi_ais_map_0.5deg_pacific_dark.png"))

```

Pacific Map - note not currently working to transform raster to Pacific view 

```{r, echo=FALSE, warning=F}

# lets aggregate the data to lat/lon bins to use fishwatchr example mapping code 
res <- 0.1
working_df$lat_bin <- round(working_df$lat / res) * res
working_df$lon_bin <- round(working_df$lon / res) * res

# count positions in each lat lon bin
presence <- working_df %>%
  group_by(lat_bin, lon_bin) %>%
    summarise(
      positions = dplyr::n(), 
    )

# set upper limit
up_lim <- 10000 
#set plot center 
new_center <- -60

# set proj for bounding box
best_proj <- "+proj=eqearth +lon_0=-60 +wktext"

# set plot limits for Pacific 
bounding_atlantic <- transform_box(xlim = c(-70, -50),
                          ylim = c(-35, -55),
                          output_crs = best_proj)
  
atlantic_map <- presence %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'positions',
                  center = new_center) %>% 
  ggplot()+
  geom_gfw_outline(center = new_center, theme = "dark") +
  geom_raster(aes(x= lon_bin, y=lat_bin, fill = positions)) +
    geom_gfw_eez(theme = 'dark', alpha = 0.2, center = new_center) +
    geom_gfw_land(theme = 'dark', center = new_center) +
    scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                       #limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +   
    coord_sf(xlim = c(bounding_atlantic$box_out[['xmin']], bounding_atlantic$box_out[['xmax']]),
           ylim = c(bounding_atlantic$box_out[['ymin']], bounding_atlantic$box_out[['ymax']]),
           crs = bounding_atlantic$out_crs) +
      theme_gfw_map(theme = 'light') 


fishwatchr::add_little_globe(atlantic_map,
                             main_box = bounding_atlantic,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperleft')  
  
  
ggsave(here::here("outputs", "figures", "voi_ais_map_0.5deg_atlantic_dark.png"))

```

# Ports 

# Chinese Ports 
```{r, echo=FALSE}
chn_ports <- readr::read_file(file = here::here("queries", ".", "150_voi_chn_ports.sql"))
outside_chn_ais<- fishwatchr::gfw_query(query = chn_ports,
                                 run_query = TRUE,
                                 con = con)$data
```

# AIS Name changes

We want to evaluate when and where vessel of interest are changing there names. 

```{r, echo=F}
# ais_change_location_q <- readr::read_file(file = here::here("queries", ".", "ais_identity_changes_v1.sql"))
# name_change <- fishwatchr::gfw_query(query = ais_change_location_q,
#                                  run_query = TRUE,
#                                  con = con)$data
# 
# name_change %>% saveRDS(here::here("data", ".", "ais_identity_changes.rds"))
name_change <- read_rds(here::here("data", ".", "ais_identity_changes.rds"))
name_change %>% write.csv(here::here("data", ".", "ais_identity_changes.csv"))

# identify LU RONG YUAN YU 715 change points 
# this name used on 13 MMSIs 
lryy715 <- bind_rows(
  # static 
  name_change %>% filter(stringr::str_detect(static_name, '715$') |
                       static_name  == 'LURONGYUANYU715' |
                       static_name  == 'LURONGYUANYU 715'),
  # prev 
  name_change %>% filter(stringr::str_detect(next_name, '715$') |
                       next_name == 'LURONGYUANYU715' |
                       next_name == 'LURONGYUANYU 715')
  )

# look aat number of different MMSIs
table(lryy715$ssvid)

# check which names are there
table(lryy715$static_name, lryy715$next_name)

View(lryy715[1:1000,])

# three names id through changes 
lryy715 %>% group_by(ssvid) %>% summarise(
  start =  min(timestamp), 
  end = max(timestamp))

# for 150400450 one position unrelated to other transmissions in the series   
look_150400450 <- filter(name_change, ssvid == '150400450')
ssvid_150400450 <- filter(name_change, ssvid == '150400450' & shipname == 'LURONGYUANYU 715')
ssvid_150400450$group <- '150400450'

# 150400460 transmission on FUYUANYU 715 so remove. 
#look_150400460 <- filter(name_change, ssvid == '150400460')

# for 15040046 transmissions over LURONGYUANYU 715
look_150400465 <- filter(name_change, ssvid == '150400465')
ssvid_150400465 <- filter(name_change, ssvid == '150400465' & between(as.Date(timestamp), as.Date('2022-12-20'), as.Date('2022-12-26')))
ssvid_150400465$group <- '150400465'

# for 150400467 transmissions over LURONGYUANYU 715 look to be one single position 
look_150400467 <- filter(name_change, ssvid == '150400467')
ssvid_150400467 <- filter(name_change, ssvid == '150400467' & shipname == 'LURONGYUANYU 715')
ssvid_150400467$group <- '150400467'

# for 150400471  transmissions over LURONGYUANYU 715 look to be one single position based on difference in time 
look_150400471  <- filter(name_change, ssvid == '150400471')
ssvid_150400471 <- filter(name_change, ssvid == '150400471' & shipname == 'LURONGYUANYU 715')
ssvid_150400471$group <- '150400471'

# for 150400476  transmissions over LURONGYUANYU 715 are isolated but could be related to the same vessel
look_150400476  <- filter(name_change, ssvid == '150400476')
ssvid_150400476 <- filter(name_change, ssvid == '150400476' & shipname == 'LURONGYUANYU 715')
ssvid_150400476$group <- '150400476'

ssvid_150400476_maybe <- filter(name_change, ssvid == '150400476' & between(as.Date(timestamp), as.Date('2022-01-06'), as.Date('2022-01-20')))

# for 150400477  transmissions over FUYUANYU 715 are isolated but could be related to the same vessel
#look_150400477  <- filter(name_change, ssvid == '150400477')

#  only static is LU RONG YUAN YU 715  
look_150400478  <- filter(name_change, ssvid == '150400478')
ssvid_150400478 <-  filter(name_change, ssvid == '150400478' & between(as.Date(timestamp), as.Date('2021-06-30'), as.Date('2021-07-01')))
ssvid_150400478$group <- '150400478'

# for 150400480  transmissions over FUYUANYU 715 
#look_150400480 <- filter(name_change, ssvid == '150400480')

# 150400483 only static is LU RONG YUAN YU 715
look_150400483  <- filter(name_change, ssvid == '150400483')
ssvid_150400483  <-  filter(name_change, ssvid == '150400483' & between(as.Date(timestamp), as.Date('2022-07-30'), as.Date('2022-07-31')))
ssvid_150400483$group <- '150400483'

# 150400488 only static is LU RONG YUAN YU 715 - series of transmissions in December 2022 - what about before then
look_150400488  <- filter(name_change, ssvid == '150400488')
ssvid_150400488  <-  filter(name_change, ssvid == '150400488' & between(as.Date(timestamp), as.Date('2022-12-24'), as.Date('2022-12-25')))
ssvid_150400488$group <- '150400488'

# 150400499 only static is LU RONG YUAN YU 715 - most transmissions close in time but before static 
look_150400499  <- filter(name_change, ssvid == '150400499')
ssvid_150400499 <-  filter(name_change, ssvid == '150400499' & between(as.Date(timestamp), as.Date('2021-10-13'), as.Date('2021-10-16')))
ssvid_150400499$group <- '150400499'

# 150400502 only static is LU RONG YUAN YU 715 - one transmissions close in time but others quite seperate  
look_150400502  <- filter(name_change, ssvid == '150400502')
ssvid_150400502  <- filter(name_change, ssvid == '150400502' & between(as.Date(timestamp), as.Date('2021-10-11'), as.Date('2021-10-12')))
ssvid_150400502$group <- '150400502'

# bind together all the data  
ssvid_150400453_g1 <- filter(name_change, ssvid == '150400453', 
                            between(as.Date(timestamp), as.Date('2020-12-20'), as.Date('2020-12-29'))) 
ssvid_150400453_g1$group <- '150400453-1'
                            
ssvid_150400453_g2 <- filter(name_change, ssvid == '150400453', 
                            between(as.Date(timestamp), as.Date('2021-05-04'), as.Date('2021-07-02'))) 
ssvid_150400453_g2$group <- '150400453-2'

ssvid_150400453_g3 <- filter(name_change, ssvid == '150400453', 
                            between(as.Date(timestamp), as.Date('2021-09-13'), as.Date('2021-11-30')))  
ssvid_150400453_g3$group <- '150400453-3'

ssvid_150400453_g3_t <- ssvid_150400453_g3 

ssvid_150400453_g4 <- filter(name_change, ssvid == '150400453', 
                            between(as.Date(timestamp), as.Date('2022-07-25'), as.Date('2022-12-28')))
ssvid_150400453_g4$group <- '150400453-4'


lryy715_time <- bind_rows(ssvid_150400450, ssvid_150400465, ssvid_150400467, ssvid_150400471, 
                          ssvid_150400476, ssvid_150400478, ssvid_150400483, ssvid_150400488, 
                          ssvid_150400499, ssvid_150400502, ssvid_150400453_g1, ssvid_150400453_g2, 
                          ssvid_150400453_g3, ssvid_150400453_g4)


head(lryy715_time)

lryy715_time %>% group_by(ssvid) %>% summarise(n=n())

lryy715_time_lines <- filter(lryy715_time, !ssvid %in% c('150400450', '150400467','150400471','150400476'))
lryy715_time_points <- filter(lryy715_time, ssvid %in% c('150400450', '150400467','150400471','150400476'))



```

Maps 

```{r, echo=F}
best_proj <- "+proj=eqearth +lon_0=-80 +wktext"  #works 

# set centre
new_center <- -80

# make sf object of lines for plotting 
recenter_lryy715 <- lryy715_time_lines %>%
  filter(!is.na(lat)) %>%
  arrange(timestamp) %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) %>%
  group_by(group) %>%
  summarize(do_union = FALSE) %>%
  sf::st_cast(., "MULTILINESTRING") %>%
  fishwatchr::recenter_sf(., center = new_center, buffer = 0)


# reset group levels so 150500453 colouration consistent 
recenter_lryy715$group[stringr::str_detect(recenter_lryy715$group, '150400453')] <- '150400453'

# make points for MMSIs with few transmitions 
recenter_lryy715_points <- lryy715_time_points %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) %>%
  fishwatchr::recenter_sf(., center = new_center, buffer = 0)

# transform lines using best projection to try deal with 180 issue 
reproj_lryy715 <- st_transform(recenter_lryy715, crs=best_proj)
reproj_lryy715_points <- st_transform(recenter_lryy715_points, crs=best_proj)


# make dark theme global map of activity 
ggplot() +
  geom_gfw_outline(center = new_center, 
                   theme = "dark") +
  geom_gfw_land(center = new_center) +
  geom_sf(
    data = reproj_lryy715,
      aes(color = group) #, 
    #color = fishwatchr::gfw_palettes$secondary[2]
  ) +
  geom_gfw_eez(theme = 'dark', center = new_center, alpha = 0.25) +
  geom_sf(
    data = reproj_lryy715_points,
    aes(color = group),
    size = 0.75
  ) +
  # scale_colour_manual(values = gfw_palettes$tracks) +
  theme_gfw_map(theme = "light") +
  theme(legend.position="right", ) +
  labs(colour = 'MMSI')

# save ouputs in the output directory 
ggsave(here::here("outputs", "figures", "LRYY715_mmsi_map_v2.png"), width = 10, height = 7)
write.csv(lryy715_time_lines, here::here("data", ".", "lryy715_time_lines.csv"))
```

```{r, echo=F}
# make a timeseries plot of the LU RONG YUAN YU 715 name changes 
time_plot_df <- lryy715_time %>% group_by(group) %>% summarise(
  first_trans = min(timestamp), 
  last_trans = max(timestamp),
  n=n()
)

# make the individual periods of 150400453 in the same group for time plot 
time_plot_df$group[stringr::str_detect(time_plot_df$group, '150400453')] <- '150400453'

# plot out name changes with time plot 
ggplot() +
  geom_segment(
    data = time_plot_df,
    aes(
      x = first_trans,
      xend = last_trans,
      # y = ssvid,
      # yend = ssvid,      
      y = group,
      yend = group,
      colour = group
    ),
    size = 2
  ) + 
  # plot points of ssvids with only single transmissions 
  geom_point(data=filter(time_plot_df, n<=2), aes(y=group, x=first_trans))+
  labs(x= 'date', y='MMSI' )+
  theme_classic() +
  theme(legend.position="none")

# save outputs in outputs directory 
ggsave(here::here("outputs", "figures", "LRYY715_timeline_map.png"), width = 10, height = 7)
  
```
```{r, echo=F}
#look to see if LRYY277 has much transmission on other vessel ssvids. Doesn't appear to be significantly different  
table(name_change$shipname)

# find data associated to LURONGYUANYU277
lryy277 <- bind_rows(
  # static 
  name_change %>% filter(stringr::str_detect(static_name, '277$') |
                       static_name  == 'LURONGYUANYU277'),
  # prev 
  name_change %>% filter(stringr::str_detect(next_name, '277$') |
                       next_name == 'LURONGYUANYU277')
  )

table(lryy277$ssvid)
# same proble as LRYY715 don't proceed with plotting 

```

```{r, echo=F}
#pull in ee data as it has cleaner names 
df <- read.csv(here::here("data", ".", "150400453.csv"))

# some of the data has lat/lon transposed. Unclear why but fix this as below -55 is clearly wrong
df$lat2 <- df$lat
df$lon2 <- df$lon
df$lat2[df$lat <= -55] <- df$lon[df$lat <= -55]  
df$lon2[df$lat <= -55] <- df$lat[df$lat <= -55]  

# normalise shipname 
df$shipname[df$shipname=='HAHHHING 3'] <- 'HAI HANG 3'
df$shipname[df$shipname=='HAIHANG3'] <- 'HAI HANG 3'
df$shipname[df$shipname=='LURONGYUANYU715'] <- 'LURONGYUANYU 715'
table(df$shipname)

# make date in R date format  
df$timestamp <- as.POSIXct(df$timestamp, format='%d/%m/%Y %H:%M')

 # add diff time column 
df <- df %>% group_by(ssvid, shipname) %>% mutate(gap_days = difftime(timestamp, lag(timestamp), units=c('days')))

# make gap segments logical column
df$seg <- FALSE
df$seg[df$gap_days<5] <- TRUE


# identify group change points based on segment differences - bit of a hack but it works 
j=1
i=1
df$grp <- NA
for (i in 2:nrow(df)){
  if(df$seg[i] != df$seg[i-1]){
    df$grp[i] <- j+1
    j = j+1 
    } else {df$grp[i] = j}
}
# manually set group point 1
df$grp[1] <- 1

# change points to vessel names currently go into their own group (due to difference in true false) - change this to the next group  
grp_tab <- df %>% group_by(grp) %>% summarise(n=n())
grp_tab$grp[grp_tab$n==1]
df$grp[df$grp %in% grp_tab$grp[grp_tab$n==1]] <- df$grp[df$grp %in% grp_tab$grp[grp_tab$n==1]] +1

# adjust change point 2 to go into group 3 
df$grp[df$grp == 2] <- df$grp[df$grp == 2]+1 

# make segments based on change points        
time_plot_df2 <- df %>% group_by(shipname, grp) %>% summarise(
  first_trans = min(timestamp), 
  last_trans = max(timestamp),
  n=n()
)
time_plot_df2
# note need to break the data into groups by continuous transmission on MMSI 

```

```{r, echo=F}
# set centre for global plot 
new_center <- -80

# make the recentered plot df 
recenter_lryy715 <- df %>%
  filter(!is.na(lat2)) %>%
  sf::st_as_sf(., 
               coords = c("lon2", "lat2"), 
               crs = 4326) %>%
  group_by(grp, shipname) %>%
  arrange(timestamp) %>%
  summarize(do_union = FALSE) %>%
  sf::st_cast(., "LINESTRING") %>%
  fishwatchr::recenter_sf(., center = new_center, buffer=0)

# make name pattern coloured map 
ggplot() +
  geom_gfw_outline(center = new_center, 
                   theme = "dark") +
  geom_gfw_land(center = new_center) +
  geom_sf(
    data = recenter_lryy715,
      aes(color = shipname) #, 
    #color = fishwatchr::gfw_palettes$secondary[2]
  ) +
  geom_gfw_eez(theme = 'dark', center = new_center, alpha = 0.25) +
  # scale_colour_manual(values = gfw_palettes$tracks) +
  theme_gfw_map(theme = "light") +
  theme(legend.position="bottom") +
  labs(colour = 'Vessel Name')

# save output in outputs directory 
ggsave(here::here("outputs", "figures", "LRYY715_name_map.png"), width = 10, height = 7)

```
```{r, echo=F}
# time_plot_df$group[stringr::str_detect(time_plot_df$group, '150400453')] <- '150400453'

# make timeline plot of name changes 
ggplot() +
  geom_segment(
    data = time_plot_df2,
    aes(
      x = first_trans,
      xend = last_trans,
      # y = ssvid,
      # yend = ssvid,      
      y = shipname,
      yend = shipname,
      colour = shipname
    ),
    size = 2
  ) + 
  # geom_point(data=filter(time_plot_df, n<=2), aes(y=group, x=first_trans))+
  labs(x= 'Date', y='Vessel Name' )+
  #   scale_x_date("",
  #   date_minor_breaks = "months",
  #   date_breaks = "year",
  #   date_labels = "%Y",
  #   limits = c(as.Date("2020-01-01"), as.Date("2022-12-31")),
  #   expand = c(0, 0)
  # )
  theme_classic() +
  theme(legend.position="none")

# save outputs 
ggsave(here::here("outputs", "figures", "LRYY715_timeline_map.png"), width = 10, height = 7)
  
```

# Name Locations 

```{r, echo=F, warning=FALSE}

# query to get best name on a day
ais_identity_q <- readr::read_file(file = here::here("queries", ".", "ais_identity_changes_v2.sql"))

# extract data 
daily_identity <- fishwatchr::gfw_query(query = ais_identity_q,
                                 run_query = TRUE,
                                 con = con)$data

# make normalised name groups 
daily_identity$shipname_g <- NA
daily_identity$shipname_g[stringr::str_detect(daily_identity$shipname, '^FU')] <- 'FU YUAN YU'
daily_identity$shipname_g[stringr::str_detect(daily_identity$shipname, '^HA')] <- 'HAI HANG'
daily_identity$shipname_g[stringr::str_detect(daily_identity$shipname, '^LU')] <- 'LU RONG YU'
daily_identity$shipname_g[stringr::str_detect(daily_identity$shipname, '^U')] <- 'LU RONG YU'
daily_identity$shipname_g[stringr::str_detect(daily_identity$shipname, '^SHUN')] <- 'SHUN HANG'

# check group relationships 
table(daily_identity$shipname,daily_identity$shipname_g)

# set plot centre 
new_center <- -80

# read WKT points into spatial object
daily_identity$pts <- lapply(daily_identity$avg_lat_lon, FUN = function(x) readWKT(x))

# extract point coordinates
daily_identity$lon <- coordinates(daily_identity$pts)[c(T,F)]
daily_identity$lat <- coordinates(daily_identity$pts)[c(F,T)]

# create bounding box for plot to set bounds 
bounding <- transform_box(xlim = c(-95, -30),
                          ylim = c(0, -55),
                          output_crs = gfw_projections("Equal Earth")$proj)

# make st object of identity points
daily_identity_points <- filter(daily_identity, !is.na(shipname_g)) %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) 

# reproject identity points object 
daily_identity_points_trans <- st_transform(daily_identity_points, crs=4326)

# map out the data 
map <- ggplot() +
  geom_gfw_land(theme = 'light', proj = gfw_projections("Equal Earth")$proj) +
  geom_gfw_eez(proj = gfw_projections("Equal Earth")$proj, colour='black') +
  geom_sf(
    # data = daily_identity,
    #   aes(x=lon, y=lat, color = shipname_g),
        data = dplyr::select(daily_identity_points_trans,-avg_lat_lon),
      aes( color = shipname_g),
      size = 1.5
    #color = fishwatchr::gfw_palettes$secondary[2]
  ) +
  #geom_gfw_eez(theme = 'light', center = new_center, alpha = 0.2) +
  # scale_colour_manual(values = gfw_palettes$tracks) +
  theme_gfw_map(theme = "light") +
  theme(legend.position="right") +
  labs(colour = 'Name Group') +
  coord_sf(xlim = c(bounding$box_out[['xmin']], bounding$box_out[['xmax']]),
           ylim = c(bounding$box_out[['ymin']], bounding$box_out[['ymax']]),
           crs = bounding$out_crs)

fishwatchr::add_little_globe(map,
                             main_box = bounding,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperright')


ggsave(here::here("outputs", "figures", "Name_group_locations.png"), width = 7, height = 8)

```
Atlantic name locations 

```{r, echo=F, warning=F}
# make the name change map focused on Atlantic squid grounds 
bounding <- transform_box(xlim = c(-70, -55),
                          ylim = c(-40, -55),
                          output_crs = gfw_projections("Equal Earth")$proj)


alpha_v <- 

map_atl <- ggplot() +
  geom_gfw_land(theme = 'light', proj = gfw_projections("Equal Earth")$proj) +
  geom_sf(
    # data = daily_identity,
    #   aes(x=lon, y=lat, color = shipname_g),
        data = dplyr::select(daily_identity_points_trans,-avg_lat_lon),
      aes(color = shipname_g),
      size = 1.5, 
      alpha_v
    #color = fishwatchr::gfw_palettes$secondary[2]
  ) +
  geom_gfw_eez(proj = gfw_projections("Equal Earth")$proj, colour='black') +
  theme_gfw_map(theme = "light") +
  theme(legend.position="right", ) +
  labs(colour = 'Name Group') +
  coord_sf(xlim = c(bounding$box_out[['xmin']], bounding$box_out[['xmax']]),
           ylim = c(bounding$box_out[['ymin']], bounding$box_out[['ymax']]),
           crs = bounding$out_crs)

fishwatchr::add_little_globe(map_atl,
                             main_box = bounding,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperright')


ggsave(here::here("outputs", "figures", "Name_group_locations_Atlantic.png"), width = 7, height = 8)
```


```{r, echo=F, warning=F}
# import name_change_l derived from ais_identity_changes_v1.sql WHERE next_name != static_name.  
# The csv of this data was obtained from BQ then manually grooming in excel to remove name 
# which weren't thought to represent actual changes in identity e.g. FUYUANYU 715 vs FU YUAN YU 715
name_change_l <- read.csv(here::here("data", ".", "name_changes_150voi_local.csv"))

# map of name changes
# create bounding box for plot to set bounds 
bounding <- transform_box(xlim = c(-95, -30),
                          ylim = c(0, -55),
                          output_crs = gfw_projections("Equal Earth")$proj)

# make st object of identity points
name_change_points <- filter(name_change_l, !is.na(lat)) %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) 

# reproject identity points object 
name_change_points_trans <- st_transform(daily_identity_points, crs=4326)

# map out the data 
ggplot() +
  geom_gfw_land(theme = 'light', proj = gfw_projections("Equal Earth")$proj) +
  geom_gfw_eez(proj = gfw_projections("Equal Earth")$proj, colour='black') +
  geom_sf(
    # data = daily_identity,
    #   aes(x=lon, y=lat, color = shipname_g),
        data = name_change_points_trans,
      #aes( color = shipname_g),
      size = 1.5,
      alpha = 0.25
    #color = fishwatchr::gfw_palettes$secondary[2]
  ) +
  #geom_gfw_eez(theme = 'light', center = new_center, alpha = 0.2) +
  # scale_colour_manual(values = gfw_palettes$tracks) +
  theme_gfw_map(theme = "light") +
  theme(legend.position="right")
  # labs(colour = 'Name Group') +
  # coord_sf(xlim = c(bounding$box_out[['xmin']], bounding$box_out[['xmax']]),
  #          ylim = c(bounding$box_out[['ymin']], bounding$box_out[['ymax']]),
  #          crs = bounding$out_crs)

ggsave(here::here("outputs", "figures", "name_change_locations_global.png"))


# fishwatchr::add_little_globe(map,
#                              main_box = bounding_box,
#                              globe_rel_size = '0.25',
#                              globe_just = 'inside',
#                              globe_position = 'upperright')


name_change_l$timestamp <- as.POSIXct(str_sub(name_change_l$timestamp,1, 19), format='%Y-%m-%d %H:%M:%S')
name_change_l$ssvid <- as.character(name_change_l$ssvid)

nrow(filter(name_change_l, timestamp <= '2022-06-01 00:00:00 GMT'))
nrow(filter(name_change_l, timestamp >= '2022-06-01 00:00:00 GMT'))


# plot out name changes with time plot 
ggplot() +
  geom_point(
    data = name_change_l,
    aes(
      x = timestamp, 
      y = ssvid
    ),
    size = 2
  ) + 
  # plot points of ssvids with only single transmissions 
  labs(x= 'Date', y='MMSI' )+
  theme_classic() +
  theme(legend.position="none")

ggsave(here::here("outputs", "figures", "name_change_times.png"))

```
# Gear Changes 

```{r, echo=F}
# add speed bins
name_change$speed_bin <- NA 
name_change$speed_bin[between(name_change$speed, 0, 1)] <- '0-1'
name_change$speed_bin[between(name_change$speed, 1, 2)] <- '1-2'
name_change$speed_bin[between(name_change$speed, 2, 3)] <- '2-3'
name_change$speed_bin[between(name_change$speed, 3, 4)] <- '3-4'
name_change$speed_bin[between(name_change$speed, 4, 5)] <- '4-5'
name_change$speed_bin[between(name_change$speed, 5, 6)] <- '5-6'
name_change$speed_bin[name_change$speed > 6] <- '6+'

# make different regions
name_change$region <- NA
name_change$region[between(name_change$lon, -120, -72) & between(name_change$lat, -60, 0)] <- 'Pacific'
name_change$region[between(name_change$lon, -61, -50) & between(name_change$lat, -49, -37)] <- 'Atlantic'

# look at distribution of data between regions
table(name_change$ssvid, name_change$region) 
# only a handful of MMSIs have enough data in each region for comparison (say 100 trans in each)

# restrict data to most common ssvids 
gear_df <- name_change %>% filter(ssvid %in% c('150402951','150402949','150402947','150402944','150402940', '150400453'))

# get proportion of activity in each 1 knot speed group less than 6 knots 
tab_df <- filter(gear_df, speed<6) %>% 
  group_by(ssvid, region, speed_bin) %>% 
    summarise(transmissions=n()) %>% 
      left_join(filter(gear_df, speed<6) %>% group_by(ssvid, region) %>% summarise(region_ttl=n())) %>% 
        mutate(prop = transmissions / region_ttl) 

# make bar plot for Pacific with bars per mmsi 
ggplot() +
  geom_bar(data=filter(tab_df, region=='Pacific'), 
                 aes(x=speed_bin, y=prop, fill=ssvid), 
                 position=position_dodge(), stat='identity')+
  labs(x='Speed knots', y='Proportion') +
  theme_classic()

# save output 
ggsave(here::here("outputs", "figures", "Pacific_speed.png"))

# make bar plot for Atlantic with bars per mmsi 
ggplot() +
  geom_bar(data=filter(tab_df, region=='Atlantic'), 
                 aes(x=speed_bin, y=prop, fill=ssvid), 
                 position=position_dodge(), stat='identity')+
  labs(x='Speed knots', y='Proportion') +
  theme_classic()

# save outputs
ggsave(here::here("outputs", "figures", "Atlantic_speed.png"))
```


```{r, echo=F}
head(name_change)
name_change <- name_change %>% mutate(year= year(timestamp), month=month(timestamp))

View(filter(name_change %>% filter(ssvid %in% c('150402951','150402949','150402947','150402944','150402940', '150400453')), speed<6) %>% 
  group_by(ssvid, region, speed_bin, year) %>% 
    summarise(transmissions=n()))
```

# AIS message types

```{r, echo=FALSE}
# Need to add class B element 

```



