---
title: "150_voi_test"
author: "Max Schofield"
date: "2022-10-21"
output:
  html_notebook:
  df_print: default
highlight: pygments
toc: yes
toc_float:
  toc_collapsed: true
toc_depth: 2

editor_options:
  chunk_output_type: inline
---

```{=html}
<style>
body {
text-align: justify}
</style>
```

# Setup

Knitr options 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load R packages 

```{r load packages, echo=F, warning=F}
load_or_install_libraries <- function(x){
  for( i in x ){
    #  require returns TRUE invisibly if it was able to load package
    if( ! require( i , character.only = TRUE ) ){
      #  If package was not able to be loaded then re-install
      install.packages( i , dependencies = TRUE )
      #  Load package after installing
      require( i , character.only = TRUE )
    }
  }
}

#  Then try/install packages...
load_or_install_libraries( c("tidyverse" , "bigrquery" ,"devtools", "DBI","glue", "lubridate", "here", "sf", "extrafont", "patchwork", "terra", "rgeos", "ggspatial") )

# get fishwatch r independently 
if (!require("fishwatchr")) {devtools::install_github("GlobalFishingWatch/fishwatchr")}
library(fishwatchr)

if (!require("extrafont"))
  install.packages("extrafont")

# Unfortunately `extrafont::font_import()` will fail on latest Rttf2pt1 package...
# so we need to install old version
devtools::install_version("Rttf2pt1", version = "1.3.8")

# Import fonts to R
# This will take few minutes
extrafont::font_import()

# remove a package causing issues 
#detach("package:plyr", unload=TRUE)
```

Establish connection to BigQuery project

```{r connection to BQ}
con <- DBI::dbConnect(drv = bigrquery::bigquery(), 
                      project = "world-fishing-827", 
                      use_legacy_sql = FALSE)
```

Set commonly used parameters for mapping

```{r define projection}
# define bounding box/area of interest
# bbox <- data.frame(x_min = -8,
#                    x_max = 3,
#                    y_min = 0,
#                    y_max = 7)
# what projection should be used for mapping
best_proj <- fishwatchr::gfw_projections("Equal Earth")$proj_string
# best_proj <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
```


# Establish Vessel of Interest 

Calling the table directly as it is saved due to being a large query

First question is establish how many vessels have the 150 MMSI prefix in total. 

```{r load in raw 150 fleet AIS data, echo=FALSE}
# q_voi_ais <- c("SELECT * FROM `world-fishing-827.scratch_max.raw_AIS_150_mmsi_prefix_2020_2022`")
# 
# all_150_ais <- fishwatchr::gfw_query(query = q_voi_ais,
#                                  run_query = TRUE, 
#                                  con = con)$data
# n_distinct(all_150_ais$ssvid)
# 
# all_150_ais %>% saveRDS(here::here("data", ".", "all_150_ais.rds"))
all_150_ais <- read_rds(here::here("data", ".", "all_150_ais.rds"))

```

This is querying the raw AIS data and there is `r n_distinct(voi_ais$ssvid)` vessels in total. 

# Remove gear from 150 vessels  

Chunk trys to identify gear and has code to write out gear datasets (hashed as these are large dfs!)

```{r remove fishing gear from 150 vessel list, echo=FALSE}
# outside china gets all 150 vessels AIS outside of China 
#outside_chn <- readr::read_file(file = here::here("queries", ".", "outside_CHN.sql"))
#outside_chn_ais<- fishwatchr::gfw_query(query = outside_chn,
#                                 run_query = TRUE,
#                                 con = con)$data
#
#outside_chn_ais %>% saveRDS(here::here("data", ".", "outside_chn_ais.rds"))
outside_chn_ais <- read_rds(here::here("data", ".", "outside_chn_ais.rds"))


# write.csv(outside_chn_ais, '../data/step1_outside_CHN.csv', row.names = F)

n_distinct(outside_chn_ais$ssvid)

# restrict down to genuine VOI
outside_AIS <- filter(all_150_ais, ssvid %in% c(outside_chn_ais$ssvid))

# get rid of percentage - indicator of gear markers 
per <- filter(outside_AIS, stringr::str_detect(shipname, '\\%'))

# get rid of ending in v - another indicator of gear markers
per_v <- filter(outside_AIS, stringr::str_detect(shipname, 'v$|V$'))

# get rid of ending in NET another indicator of gear markers
per_v_net <- filter(outside_AIS, stringr::str_detect(shipname, 'NET'))

# get rid of - in the name as another indicator of gear markers
per_v_net_dash <- filter(outside_AIS, stringr::str_detect(shipname, '-'))

# remove vessels
no_per_v_net_dash <- outside_AIS %>% filter(!ssvid %in% unique(c(
    per$ssvid, 
    per_v$ssvid,
    per_v_net$ssvid, 
    per_v_net_dash$ssvid)))

# write out data to visaulise
# write.csv(no_per_v_net_dash, '../data/non_gear_outside_CHN.csv', row.names = F)

# write out the discarded datasets to see if any aligns with areas of interest 
# write.csv(per, '../data/150voi_percentage_in_name.csv', row.names = F)
# write.csv(per_v, '../data/150voi_voltage_in_name.csv', row.names = F)
# write.csv(per_v_net, '../data/150voi_net_in_name.csv', row.names = F)
# write.csv(per_v_net_dash, '../data/150voi_dash_in_name.csv', row.names = F)

n_distinct(outside_AIS$ssvid)
n_distinct(no_per_v_net_dash$ssvid)

data <- no_per_v_net_dash[!is.na(no_per_v_net_dash$lat) & !is.na(no_per_v_net_dash$lon) ,]
n_distinct(data$ssvid)

# still missing where a big chunk data drops out 
# check the opposite of the gear query 

likely_gear <- outside_AIS %>% filter(ssvid %in% unique(c(
    per$ssvid, 
    per_v$ssvid,
    per_v_net$ssvid, 
    per_v_net_dash$ssvid)))
# write.csv(likely_gear, '../data/likely_gear.csv', row.names = F)
```

# Look at activity outside of China

Lots of the activity and ssvids are only active in the Chinese EEZ, this activity is 
unrelated to the activity of interest in existing JAC intreps and should be removed. 

The code also looks at setting a limit on minimum number of points outside of China 
to try and remove vessels active in the Chinese EEZ with a number of positional 
anomalies outside of this location. 

```{r remove activity exclusively in China, echo=FALSE}

# still lots of CHN transmissions. Drop them with a lat/lon subset to make sure we don't still have
# exclusively chinese vessels 
# add index to data 
voi <- data %>% mutate(id = seq(1,nrow(data),1))
chn <- voi %>% filter(between(lon, 107, 124) & between(lat, 18, 41))
n_distinct(chn$ssvid)
n_distinct(voi$ssvid)

# remove data points in China. 
look <- voi %>% filter(!id %in% chn$id)
n_distinct(look$ssvid)
# write.csv(look, '../data/outside_chn_v2.csv', row.names = F)

# run more then 10 transmission query to  remove vessels with bitflips out of CHN 
more_then10 <- look %>% group_by(ssvid) %>% summarise(n=n()) %>% filter(n>10)
outside_chn_more_then10 <- look %>% filter(ssvid %in% (more_then10$ssvid))
n_distinct(outside_chn_more_then10$ssvid)

# run more then 5 transmission query to  remove vessels with bitflips out of CHN 
more_then5 <- look %>% group_by(ssvid) %>% summarise(n=n()) %>% filter(n>5)
outside_chn_more_then5 <- look %>% filter(ssvid %in% (more_then5$ssvid))
n_distinct(outside_chn_more_then5$ssvid)


# writing out data. hashed as dfs are large for
######
# outside_chn_more_then10 %>% write.csv(here::here("data", ".", paste0("active_outside_chn_10_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# outside_chn_more_then5 %>% write.csv(here::here("data", ".", paste0("active_outside_chn_5_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# look %>% filter(!ssvid %in% (outside_chn_more_then10$ssvid))%>% write.csv(here::here("data", ".", paste0("dropped_outside_chn_10_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# look %>% filter(!ssvid %in% (outside_chn_more_then5$ssvid)) %>% write.csv(here::here("data", ".", paste0("dropped_outside_chn_5_",str_replace_all(Sys.Date(), '-','_'),".csv")))
# 

drp_5 <- look %>% filter(!ssvid %in% (outside_chn_more_then5$ssvid))
#View(drp_5 %>% group_by(ssvid) %>% summarise(n=n()))
# pattern with 15040 being in our fleet of interest. 

# # look at data dropped by the more then 10 criteria 
# removed <- data %>% filter(!ssvid %in% (more_then10$ssvid))
# write.csv(removed, '../data/removed.csv', row.names = F)
# check_ids <-  removed %>% group_by(ssvid) %>% summarise(trans=n()) %>% filter(trans>10)
# 
# check <- filter(removed,  ssvid %in% check_ids$ssvid)
# write.csv(check, '../data/check.csv', row.names = F)
# # working as expected
# write it out to visaulise
# write.csv(outside_chn_more_then10, '../data/active_outside_chn.csv', row.names = F)

# create more then 10 threshold
more_then10_int <- look %>% group_by(ssvid) %>% summarise(n=n()) %>% filter(n>10 | str_detect(ssvid, "^15040"))

# create new working df with vessels with >10 transmissions not thought to be gear 
working_df <- filter(data, ssvid %in% more_then10_int$ssvid)

# add year and month cols 
working_df$year  <- year(working_df$timestamp) 
working_df$month  <- month(working_df$timestamp) 

# look to see is 15040 is the vessel of interest 
table(filter(data, str_detect(ssvid, "^15040"))$shipname)
table(working_df$shipname)

# collate some information on vessels of interest dataset
match_ves <- working_df %>% 
    group_by(ssvid) %>% 
      summarise(positions = n(), 
                names = paste(unique(shipname), collapse="; "), 
                first_timestamp = min(timestamp), 
                last_timestamp = max(timestamp), 
                timespan = difftime(last_timestamp, first_timestamp, units="days")) %>%
        arrange(desc(positions))
              
#View(match_ves)

# write out df 
#match_ves %>% write.csv(here::here("data", ".", paste0("150_voi_usage_spire_",str_replace_all(Sys.Date(), '-','_'),".csv")))

# filter the whole dataset to only retain the active outside of china vessels (with their china transmissions)
focal <- all_150_ais %>% filter(ssvid %in% unique(outside_chn_more_then10$ssvid)) 
focal <- focal[!is.na(focal$lat) & !is.na(focal$lon) ,]
# focal <- voi_ais %>% filter(ssvid %in% unique(active_outside_chn$ssvid)) 
# write.csv(focal, '../data/all_ais_150_active.csv', row.names = F)

# voi %>% group_by(ssvid) %>% arrange(ssvid, timestamp) %>% mutate(time = difftime(timestamp, lag(timestamp)))

```

Of the `r n_distinct(voi_ais$ssvid)` total MMSIs associated with the 150 prefix,  `r n_distinct(outside_chn_vessels$ssvid)` transmitted outside the Chinese EEZ. 

Of the MMSIs operating outside China many have names which indicated they are associated 
with likely fishing gear. MMSIs associated with likely gear was removed from our vessel
of interest list based on removing MMSIs either transmitting a %, a Voltage indicator (V), 
the word 'NET' in the shipname, which are indicators of fishing gear. 

This filtering removed `r n_distinct(outside_AIS$ssvid) - n_distinct(no_per_v_net_dash$ssvid)`
MMSIs from our fleet of interest. Resulting in `r n_distinct(no_per_v_net_dash$ssvid)` remaining 
in our vessels of interest. 

Further filtering was conducted on vessels with less than 10 AIS transmissions between 2021 and 2022 which removed `r n_distinct(outside_AIS$ssvid) - n_distinct(more_then10$ssvid)` vessel from the analysis fleet leaving `n_distinct(more_then10$ssvid)` vessels. 


# Established voi list 
```{r import established VoI list from BQ, echo=FALSE}
# Read in agreed 225 voi with TMT 

q_voi_est <- c("SELECT * FROM `world-fishing-827.scratch_max.150_voi_ssvid`")

voi_est <- fishwatchr::gfw_query(query = q_voi_est,
                                 run_query = TRUE, 
                                 con = con)$data
```

## Location

# Location in space and time

Look at the consistency of location and fleet size through space and time.

```{r Figure X global heatmap of 150 fleet AIS, echo=FALSE}

# lets aggregate the data to lat/lon bins to use fishwatchr example mapping code 
working_df$lat_bin <- round(working_df$lat/0.5)*0.5
working_df$lon_bin <- round(working_df$lon/0.5)*0.5

mmsi_list <- read.csv(here::here("data", ".", "MMSIs of interest.csv"), header=F)

# count positions in each lat lon bin
presence <- working_df %>%
# filter to final mmsi list
  filter(ssvid %in% mmsi_list$V1) %>% 
  group_by(lat_bin, lon_bin) %>%
    summarise(
      positions = dplyr::n(), 
    )

table(is.na(presence$positions))

# set upper limit
up_lim <- 5000 
new_center <- -80
# reset poistions 
#presence$positions[presence$positions>up_lim] <- up_lim

  presence %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'positions',
                  center = new_center) %>%
  ggplot() +
  geom_gfw_outline(center = new_center, 
               theme = "dark") +
  geom_raster(aes(x = lon_bin,
                  y = lat_bin,
                  fill = positions)) +
  geom_gfw_land(theme = 'dark', center = new_center) +
  geom_gfw_eez(theme = 'dark', center = new_center, alpha = 0.2) +
  scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                       limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +
  labs(fill = 'AIS Positions') +
  theme_gfw_map(theme = 'light')

ggsave(here::here("outputs", "figures", "voi_ais_map_0.5deg_global_dark.png"))

```
Pacific Map  

```{r Figure X Pacific centered map of AIS postions, echo=FALSE, warning=F}

# lets aggregate the data to lat/lon bins to use fishwatchr example mapping code 
res <- 0.5
working_df$lat_bin <- round(working_df$lat / res) * res
working_df$lon_bin <- round(working_df$lon / res) * res

# count positions in each lat lon bin
presence <- working_df %>%
  group_by(lat_bin, lon_bin) %>%
    summarise(
      positions = dplyr::n(), 
    )

# set upper limit
up_lim <- 5000 
#set plot center 
new_center <- -90

# set proj for bounding box
best_proj <- "+proj=eqearth +lon_0=-90 +wktext"

# set plot limits for Pacific 
bounding_pacific <- transform_box(xlim = c(-120, -70),
                          ylim = c(10, -55),
                          output_crs = best_proj)
  
pacific_map <- presence %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'positions',
                  center = new_center) %>% 
  ggplot()+
  geom_gfw_outline(center = new_center, theme = "dark") +
  geom_raster(aes(x= lon_bin, y=lat_bin, fill = positions)) +
    geom_gfw_eez(theme = 'dark', alpha = 0.4, center = new_center) +
    geom_gfw_land(theme = 'dark', center = new_center) +
    scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                       limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +   
    coord_sf(xlim = c(bounding_pacific$box_out[['xmin']], bounding_pacific$box_out[['xmax']]),
           ylim = c(bounding_pacific$box_out[['ymin']], bounding_pacific$box_out[['ymax']]),
           crs = bounding_pacific$out_crs) +
    labs(fill = 'AIS Positions') +
      theme_gfw_map(theme = 'light') 


fishwatchr::add_little_globe(pacific_map,
                             main_box = bounding_pacific,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperright')  
  
  
ggsave(here::here("outputs", "figures", "voi_ais_map_0.5deg_pacific_dark.png"), width = 6, height = 8)

```

Atlantic Map - note not currently working to transform raster to Pacific view 

```{r Figue X Atlantic centrered map, echo=FALSE, warning=F}

# lets aggregate the data to lat/lon bins to use fishwatchr example mapping code 
res <- 0.5
working_df$lat_bin <- round(working_df$lat / res) * res
working_df$lon_bin <- round(working_df$lon / res) * res

# count positions in each lat lon bin
presence <- working_df %>%
  group_by(lat_bin, lon_bin) %>%
    summarise(
      positions = dplyr::n(), 
    )

# set upper limit
up_lim <- 10000 
#set plot center 
new_center <- -60

# set proj for bounding box
best_proj <- "+proj=eqearth +lon_0=-60 +wktext"

# set plot limits for Pacific 
bounding_atlantic <- transform_box(xlim = c(-70, -50),
                          ylim = c(-35, -55),
                          output_crs = best_proj)
  
atlantic_map <- presence %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'positions',
                  center = new_center) %>% 
  ggplot()+
  geom_gfw_outline(center = new_center, theme = "dark") +
  geom_raster(aes(x= lon_bin, y=lat_bin, fill = positions)) +
    geom_gfw_eez(theme = 'dark', alpha = 0.4, center = new_center) +
    geom_gfw_land(theme = 'dark', center = new_center) +
    scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                       limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +   
    coord_sf(xlim = c(bounding_atlantic$box_out[['xmin']], bounding_atlantic$box_out[['xmax']]),
           ylim = c(bounding_atlantic$box_out[['ymin']], bounding_atlantic$box_out[['ymax']]),
           crs = bounding_atlantic$out_crs) +
      labs(fill = 'AIS Positions') +
      theme_gfw_map(theme = 'light') 


fishwatchr::add_little_globe(atlantic_map,
                             main_box = bounding_atlantic,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperleft')  
  
  
ggsave(here::here("outputs", "figures", "voi_ais_map_0.5deg_atlantic_dark.png"), width = 6, height = 8)

```

North Pacifc Map  

```{r Figure X North pacific centered map, echo=FALSE, warning=F}

# lets aggregate the data to lat/lon bins to use fishwatchr example mapping code 
res <- 0.5
working_df$lat_bin <- round(working_df$lat / res) * res
working_df$lon_bin <- round(working_df$lon / res) * res

# count positions in each lat lon bin
presence <- working_df %>%
  group_by(lat_bin, lon_bin) %>%
    summarise(
      positions = dplyr::n(), 
    )

# set upper limit
up_lim <- 5000 
#set plot center 
new_center <- 160

# set proj for bounding box
best_proj <- "+proj=eqearth +lon_0=160 +wktext"

# set plot limits for Pacific 
bounding_np <- transform_box(xlim = c(130, -170),
                             #xlim = c(-170, 130),
                           #xlim = c(130, -170),
                          ylim = c(35, 50),
                          output_crs = best_proj)

# Specify custom x-axis breaks and labels
custom_breaks <- c(130,150,170, -170)
custom_labels <- c("130° E", "150° E", "170° E", "170° W")

north_pacific_map <- presence %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'positions',
                  center = new_center) %>% 
  ggplot()+
  geom_gfw_outline(center = new_center, theme = "dark") +
  geom_raster(aes(x= lon_bin, y=lat_bin, fill = positions)) +
    geom_gfw_eez(theme = 'dark', alpha = 0.4, center = new_center) +
    geom_gfw_land(theme = 'dark', center = new_center) +
    scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                       limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +   
    coord_sf(xlim = c(bounding_np$box_out[['xmin']], bounding_np$box_out[['xmax']]),
      ylim = c(bounding_np$box_out[['ymin']], bounding_np$box_out[['ymax']]),
      crs = bounding_np$out_crs) +
    scale_x_continuous(breaks = custom_breaks, labels = custom_labels)+
    labs(fill = 'AIS Positions') +
    theme_gfw_map(theme = 'light') 


fishwatchr::add_little_globe(north_pacific_map,
                             main_box = bounding_np,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperleft')  
  
  
ggsave(here::here("outputs", "figures", "voi_ais_map_0.5deg_north_pacific_dark.png"), width = 6, height = 8)

```

# Ports 

# Chinese Ports 
```{r Look at port usage data, echo=FALSE}
chn_ports <- readr::read_file(file = here::here("queries", ".", "150_voi_chn_ports.sql"))
outside_chn_ais<- fishwatchr::gfw_query(query = chn_ports,
                                 run_query = TRUE,
                                 con = con)$data
# linking in the query here. Visualised the port data using Geovis as there was no port related outputs. 

```

# AIS Name changes

We want to evaluate when and where vessel of interest are changing there names. 

```{r set up data for LLRYY715 case study, echo=F}
# pull in ee data as it has cleaner names 
df <- read.csv(here::here("data", ".", "150400453.csv"))

# some of the data has lat/lon transposed. Unclear why but fix this as below -55 is clearly wrong
df$lat2 <- df$lat
df$lon2 <- df$lon
df$lat2[df$lat <= -55] <- df$lon[df$lat <= -55]  
df$lon2[df$lat <= -55] <- df$lat[df$lat <= -55]  

# normalise shipname 
df$shipname[df$shipname=='HAHHHING 3'] <- 'HAI HANG 3'
df$shipname[df$shipname=='HAIHANG3'] <- 'HAI HANG 3'
df$shipname[df$shipname=='LURONGYUANYU715'] <- 'LURONGYUANYU 715'
table(df$shipname)

# make date in R date format  
df$timestamp <- as.POSIXct(df$timestamp, format='%d/%m/%Y %H:%M')

 # add diff time column 
df <- df %>% group_by(ssvid, shipname) %>% mutate(gap_days = difftime(timestamp, lag(timestamp), units=c('days')))

# make gap segments logical column
df$seg <- FALSE
df$seg[df$gap_days<5] <- TRUE


# identify group change points based on segment differences - bit of a hack but it works 
j=1
i=1
df$grp <- NA
for (i in 2:nrow(df)){
  if(df$seg[i] != df$seg[i-1]){
    df$grp[i] <- j+1
    j = j+1 
    } else {df$grp[i] = j}
}
# manually set group point 1
df$grp[1] <- 1

# change points to vessel names currently go into their own group (due to difference in true false) - change this to the next group  
grp_tab <- df %>% group_by(grp) %>% summarise(n=n())
grp_tab$grp[grp_tab$n==1]
df$grp[df$grp %in% grp_tab$grp[grp_tab$n==1]] <- df$grp[df$grp %in% grp_tab$grp[grp_tab$n==1]] +1

# adjust change point 2 to go into group 3 
df$grp[df$grp == 2] <- df$grp[df$grp == 2]+1 

df$region <- 'Pacific or Transit'
#df$region[between(df$lon, -120, -72) & between(df$lat, -60, 0)] <- 'Pacific or Transit'
df$region[between(df$lon, -61, -50) & between(df$lat, -49, -37)] <- 'Atlantic'

table(df$region)

# make segments based on change points        
time_plot_df2 <- df %>% group_by(shipname, grp) %>% summarise(
  first_trans = min(timestamp), 
  last_trans = max(timestamp),
  n=n()
)
time_plot_df2
# note need to break the data into groups by continuous transmission on MMSI 

# make segments based on change points        
time_plot_df3 <- df %>% group_by(region, shipname, grp) %>% summarise(
  first_trans = min(timestamp), 
  last_trans = max(timestamp),
  n=n()
)
time_plot_df3

```

```{r Figure 2 timeline of 150400453 name changes, echo=F}

# query to get best name on a day
ais_identity_q <- readr::read_file(file = here::here("queries", ".", "ais_identity_changes_v2.sql"))

# extract data 
daily_identity <- fishwatchr::gfw_query(query = ais_identity_q,
                                 run_query = TRUE,
                                 con = con)$data


# read WKT points into spatial object
daily_identity$pts <- lapply(daily_identity$avg_lat_lon, FUN = function(x) readWKT(x))

# extract point coordinates
daily_identity$lon <- coordinates(daily_identity$pts)[c(T,F)]
daily_identity$lat <- coordinates(daily_identity$pts)[c(F,T)]


# check data completeness 
daily_identity %>% filter(ssvid == '150400453') %>% group_by(shipname) %>% summarise(first = min(day), last =max(day))

# restrict to voi
voi_lryy <- daily_identity %>% filter(ssvid == '150400453')

# pull out names to normalise
table(voi_lryy$shipname)

# normalise shipname 
voi_lryy$shipname[voi_lryy$shipname=='HAHHHING 3'] <- 'HAI HANG 3'
voi_lryy$shipname[voi_lryy$shipname=='HAIHANG3'] <- 'HAI HANG 3'
voi_lryy$shipname[voi_lryy$shipname=='LURONGYUANYU715'] <- 'LURONGYUANYU 715'
voi_lryy$shipname[voi_lryy$shipname=='HAI HANG 3    XX'] <- 'HAI HANG 3'
voi_lryy$shipname[voi_lryy$shipname=='FUYUANYU 715  XX'] <- 'FUYUANYU 715'
voi_lryy$shipname[voi_lryy$shipname=='FUXHHNYU 715'] <- 'FUYUANYU 715'
voi_lryy$shipname[voi_lryy$shipname=='FUXHHNYU9995'] <- 'FUYUANYU9995'

table(voi_lryy$shipname)

 # add diff time column 
voi_lryy <- voi_lryy %>% group_by(ssvid, shipname) %>% mutate(gap_days = difftime(day, lag(day), units=c('days')))

# make gap segments logical column
voi_lryy$seg <- FALSE
voi_lryy$seg[voi_lryy$gap_days<5] <- TRUE


# identify group change points based on segment differences - bit of a hack but it works 
j=1
i=1
voi_lryy$grp <- NA
for (i in 2:nrow(voi_lryy)){
  if(voi_lryy$seg[i] != voi_lryy$seg[i-1]){
    voi_lryy$grp[i] <- j+1
    j = j+1 
    } else {voi_lryy$grp[i] = j}
}
# manually set group point 1
voi_lryy$grp[1] <- 1

# change points to vessel names currently go into their own group (due to difference in true false) - change this to the next group  
grp_tab2 <- voi_lryy %>% group_by(grp) %>% summarise(n=n())
grp_tab2$grp[grp_tab2$n==1]
voi_lryy$grp[voi_lryy$grp %in% grp_tab2$grp[grp_tab2$n==1]] <- voi_lryy$grp[voi_lryy$grp %in% grp_tab2$grp[grp_tab2$n==1]] +1

# adjust change point 2 to go into group 3 
voi_lryy$grp[voi_lryy$grp == 2] <- voi_lryy$grp[voi_lryy$grp == 2]+1 

voi_lryy$region <- 'Pacific or Transit'
voi_lryy$region[between(voi_lryy$lon, -61, -50) & between(voi_lryy$lat, -49, -37)] <- 'Atlantic'

table(voi_lryy$region)

# make segments based on change points        
time_plot_df4 <- voi_lryy %>% group_by(region, shipname, grp) %>% summarise(
  first_trans = min(day), 
  last_trans = max(day),
  n=n()
)
time_plot_df4

# make at least 1 day window for visibility 
time_plot_df4$last_trans[time_plot_df4$shipname == 'LURONGYUANYU 581'] <- "2021-02-18"

# hack for two missing rows into the plot evident in EE data  
add_row <- time_plot_df4[11,]
add_row$grp <- 25
add_row$first_trans <- as.POSIXct('2020-07-15 00:00:00')         
add_row$last_trans <- as.POSIXct('2021-01-01 00:00:00')         

add_row2 <- time_plot_df4[27,]
add_row2$grp <- 15
add_row2$first_trans <- as.POSIXct('2020-07-14 20:30:00')         
add_row2$last_trans <- as.POSIXct('2020-07-15 00:00:00')         



time_plot_df5 <- bind_rows(time_plot_df4, add_row, add_row2)



# make timeline plot of name changes 
ggplot() +
  geom_segment(
    data = time_plot_df5,
    aes(
      x = first_trans,
      xend = last_trans,
      y = region,
      yend = region,
      colour = shipname
    ),
    size = 2
  ) + 
  scale_colour_manual(values = gfw_palettes$tracks) +
  # geom_point(data=filter(time_plot_df, n<=2), aes(y=group, x=first_trans))+
  labs(x= 'Date', y='Vessel Name', colour='Vessel Name' )+
  #   scale_x_date("",
  #   date_minor_breaks = "months",
  #   date_breaks = "year",
  #   date_labels = "%Y",
  #   limits = c(as.Date("2020-01-01"), as.Date("2022-12-31")),
  #   expand = c(0, 0)
  # )
  theme_classic() +
  theme(legend.position="bottom")

ggsave(here::here("outputs", "figures", "LRYY715_timeline_map_v6.png"), width = 10, height = 7)
```

```{r Figure 1 map of 150400453 name changes, echo=F}
# add centre 
new_center <- -80


# can't make segs for groups with less than 2 points
drop <- voi_lryy %>% group_by(grp) %>% summarise(n=n()) %>% filter(n<2)
seg_df <- voi_lryy %>% filter(!grp %in% c(drop$grp))

# only one point for LURONGYUANYU 581 drop out 
seg_df %>% group_by(grp, shipname) %>% summarise(n=n())

# add extra date for lryy581 to be consistent with time plot 
seg_lryy581 <- seg_df %>% filter(shipname == 'LURONGYUANYU 581')
seg_lryy581$day <- as.Date("2021-02-18") 
seg_lryy581$lon <- -60.199999 


seg_df2 <- bind_rows(seg_df, seg_lryy581) 

# make the recentered plot df 
recenter_lryy715_v2 <- seg_df2 %>%
  filter(!is.na(lat)) %>%
  dplyr::select(shipname, grp, lat, lon, day) %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) %>%
  group_by(grp, shipname) %>%
  arrange(day) %>%
  summarize(do_union = FALSE) %>%
  sf::st_cast(., "LINESTRING") %>%
  fishwatchr::recenter_sf(., center = new_center, buffer=0)

# make name pattern coloured map 
ggplot() +
  geom_gfw_outline(center = new_center, 
                   theme = "dark") +
  geom_gfw_land(center = new_center) +
  geom_sf(
    data = recenter_lryy715_v2,
      aes(color = shipname, 
          ) 
  ) +
  geom_gfw_eez(theme = 'dark', center = new_center, alpha = 0.30) +
  scale_colour_manual(values = gfw_palettes$tracks) +
  theme_gfw_map(theme = "light") +
  theme(legend.position="bottom") +
  labs(colour = 'Vessel Name') 

# save output in outputs directory 
ggsave(here::here("outputs", "figures", "LRYY715_name_map_v3.png"), width = 11, height = 7)

```

# Name Locations 

```{r Figure X name group locations in squid grounds , echo=F, warning=FALSE}

# make normalised name groups 
daily_identity$shipname_g <- NA
daily_identity$shipname_g[stringr::str_detect(daily_identity$shipname, '^FU')] <- 'FU YUAN YU'
daily_identity$shipname_g[stringr::str_detect(daily_identity$shipname, '^HA')] <- 'HAI HANG'
daily_identity$shipname_g[stringr::str_detect(daily_identity$shipname, '^LU')] <- 'LU RONG YUAN YU'
daily_identity$shipname_g[stringr::str_detect(daily_identity$shipname, '^U')] <- 'LU RONG YUAN YU'
daily_identity$shipname_g[stringr::str_detect(daily_identity$shipname, '^SHUN')] <- 'SHUN HANG'

# check group relationships 
table(daily_identity$shipname,daily_identity$shipname_g)

# remove values that aren't in the name groups 
daily_identity <- daily_identity %>% filter(!is.na(shipname_g))

# make alpha based on proportion of values in each name group
alpha_v <- daily_identity %>% group_by(shipname_g) %>% 
  summarise(freq = n()) %>% mutate(prop = freq/nrow(daily_identity))

daily_identity <- left_join(daily_identity, dplyr::select(alpha_v, shipname_g, prop)) 

# set plot centre 
new_center <- -80

# read WKT points into spatial object
daily_identity$pts <- lapply(daily_identity$avg_lat_lon, FUN = function(x) readWKT(x))

# extract point coordinates
daily_identity$lon <- coordinates(daily_identity$pts)[c(T,F)]
daily_identity$lat <- coordinates(daily_identity$pts)[c(F,T)]

# create bounding box for plot to set bounds 
bounding <- transform_box(xlim = c(-125, -30),
                          ylim = c(5, -55),
                          output_crs = gfw_projections("Equal Earth")$proj)

# make st object of identity points
daily_identity_points <- filter(daily_identity, !is.na(shipname_g)) %>%
  arrange(desc(shipname_g)) %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) 

# reproject identity points object 
daily_identity_points_trans <- st_transform(daily_identity_points, crs=4326)


# map out the data 
map <- ggplot() +
  geom_gfw_land(theme = 'light', proj = gfw_projections("Equal Earth")$proj) +
  geom_gfw_eez(proj = gfw_projections("Equal Earth")$proj, colour='black') +
  geom_sf(
    # data = daily_identity,
    #   aes(x=lon, y=lat, color = shipname_g),
        data = dplyr::select(daily_identity_points_trans,-avg_lat_lon),
      aes( color = shipname_g),
      size = 1.5, 
      alpha = data.frame(daily_identity_points_trans)$prop
    #color = fishwatchr::gfw_palettes$secondary[2]
  ) +
  #geom_gfw_eez(theme = 'light', center = new_center, alpha = 0.2) +
  scale_colour_manual(values = gfw_palettes$tracks) +
  theme_gfw_map(theme = "light") +
  theme(legend.position="right") +
  labs(colour = 'Name Group') +
  coord_sf(xlim = c(bounding$box_out[['xmin']], bounding$box_out[['xmax']]),
           ylim = c(bounding$box_out[['ymin']], bounding$box_out[['ymax']]),
           crs = bounding$out_crs)

fishwatchr::add_little_globe(map,
                             main_box = bounding,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperright')


ggsave(here::here("outputs", "figures", "Name_group_locations_squid_grounds.png"), width = 7, height = 8)

# investigte extent to overplotting in Atlantic squid grounds in QGIS
# write.csv(dplyr::select(daily_identity, seg_id, day, ssvid, shipname, lon, lat), here::here("data", ".", "daily_identity.csv"))
```


```{r Figure X name change locations for the 150 fleet, echo=F, warning=F}
# import name_change_l derived from ais_identity_changes_v1.sql WHERE next_name != static_name.  
# The csv of this data was obtained from BQ then manually grooming in excel to remove name 
# which weren't thought to represent actual changes in identity e.g. FUYUANYU 715 vs FU YUAN YU 715
name_change_l <- read.csv(here::here("data", ".", "name_changes_150voi_local.csv"))

# map of name changes
# create bounding box for plot to set bounds 
bounding <- transform_box(xlim = c(-95, -30),
                          ylim = c(0, -55),
                          output_crs = gfw_projections("Equal Earth")$proj)

# make st object of identity points
name_change_points <- filter(name_change_l, !is.na(lat)) %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) 

# reproject identity points object 
name_change_points_trans <- st_transform(name_change_points, crs=4326)

# map out the data 
ggplot() +
  geom_gfw_land(theme = 'light', proj = gfw_projections("Equal Earth")$proj) +
  geom_gfw_eez(proj = gfw_projections("Equal Earth")$proj, colour='black') +
  geom_sf(
    # data = daily_identity,
    #   aes(x=lon, y=lat, color = shipname_g),
        data = name_change_points_trans,
      #aes( color = shipname_g),
      size = 1.5,
      alpha = 0.25
    #color = fishwatchr::gfw_palettes$secondary[2]
  ) +
  #geom_gfw_eez(theme = 'light', center = new_center, alpha = 0.2) +
  # scale_colour_manual(values = gfw_palettes$tracks) +
  theme_gfw_map(theme = "light") +
  theme(legend.position="right")
  # labs(colour = 'Name Group') +
  # coord_sf(xlim = c(bounding$box_out[['xmin']], bounding$box_out[['xmax']]),
  #          ylim = c(bounding$box_out[['ymin']], bounding$box_out[['ymax']]),
  #          crs = bounding$out_crs)

ggsave(here::here("outputs", "figures", "name_change_locations_global.png"))
```


```{r Figure X name change timings for the 150 fleet, echo=F, warning=F}
# fishwatchr::add_little_globe(map,
#                              main_box = bounding_box,
#                              globe_rel_size = '0.25',
#                              globe_just = 'inside',
#                              globe_position = 'upperright')


name_change_l$timestamp <- as.POSIXct(str_sub(name_change_l$timestamp,1, 19), format='%Y-%m-%d %H:%M:%S')
name_change_l$ssvid <- as.character(name_change_l$ssvid)

nrow(filter(name_change_l, timestamp <= '2022-06-01 00:00:00 GMT'))
nrow(filter(name_change_l, timestamp >= '2022-06-01 00:00:00 GMT'))


# plot out name changes with time plot 
ggplot() +
  geom_point(
    data = name_change_l,
    aes(
      x = timestamp, 
      y = ssvid
    ),
    size = 2
  ) + 
  geom_vline(xintercept=c(as.POSIXct(c('2020-01-01', '2021-01-01', '2022-01-01','2023-01-01'))), lty=3, colour='black') + 
  # plot points of ssvids with only single transmissions 
  labs(x= 'Date', y='MMSI' )+
  theme_classic() +
  theme(legend.position="none")

ggsave(here::here("outputs", "figures", "name_change_times.png"))

```
# Gear Changes 

```{r Figure X speed groupings atlantic vs pacific, echo=F}
# add speed bins
name_change$speed_bin <- NA 
name_change$speed_bin[between(name_change$speed, 0, 1)] <- '0-1'
name_change$speed_bin[between(name_change$speed, 1, 2)] <- '1-2'
name_change$speed_bin[between(name_change$speed, 2, 3)] <- '2-3'
name_change$speed_bin[between(name_change$speed, 3, 4)] <- '3-4'
name_change$speed_bin[between(name_change$speed, 4, 5)] <- '4-5'
name_change$speed_bin[between(name_change$speed, 5, 6)] <- '5-6'
name_change$speed_bin[name_change$speed > 6] <- '6+'

# make different regions
name_change$region <- NA
name_change$region[between(name_change$lon, -120, -72) & between(name_change$lat, -60, 0)] <- 'Pacific'
name_change$region[between(name_change$lon, -61, -50) & between(name_change$lat, -49, -37)] <- 'Atlantic'

# look at distribution of data between regions
table(name_change$ssvid, name_change$region) 
# only a handful of MMSIs have enough data in each region for comparison (say 100 trans in each)

# restrict data to most common ssvids 
gear_df <- name_change %>% filter(ssvid %in% c('150402951','150402949','150402947','150402944','150402940', '150400453'))

# get proportion of activity in each 1 knot speed group less than 6 knots 
tab_df <- filter(gear_df, speed<6) %>% 
  group_by(ssvid, region, speed_bin) %>% 
    summarise(transmissions=n()) %>% 
      left_join(filter(gear_df, speed<6) %>% group_by(ssvid, region) %>% summarise(region_ttl=n())) %>% 
        mutate(prop = transmissions / region_ttl) 

# make bar plot for Pacific with bars per mmsi 
p1 <- ggplot() +
  geom_bar(data=filter(tab_df, region=='Pacific'), 
                 aes(x=speed_bin, y=prop, fill=ssvid), 
                 position=position_dodge(), stat='identity')+
  scale_fill_manual(values=gfw_palette('diverging')) +
  labs(x='Speed knots', y='Proportion', fill='MMSI', title='Pacific') +
  ylim(0,1)+
  theme_classic()

# save output 
#ggsave(here::here("outputs", "figures", "Pacific_speed.png"))

# make bar plot for Atlantic with bars per mmsi 
p2 <- ggplot() +
  geom_bar(data=filter(tab_df, region=='Atlantic'), 
                 aes(x=speed_bin, y=prop, fill=ssvid), 
                 position=position_dodge(), stat='identity')+
  scale_fill_manual(values=gfw_palette('diverging')) +
  labs(x='Speed knots', y='Proportion', fill='MMSI', title='Atlantic') +
  ylim(0,1)+
  theme_classic()

combined <- p1 + p2 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

combined
# save outputs
ggsave(here::here("outputs", "figures", "Pacific_Atlantic_speed.png"))
```


# AIS message types

```{r look at AIS message types in working df data, echo=FALSE}
# Need to add class B element 

# 11 MMSIs that change identity 
voi_that_transmit <- c('150402944', '150400453', '150402940', '150402947', '150402949', '150402951', 
                       '150403003', '150400465', '150400483', '150403000', '150400467')

# add class A/B information to df
table(working_df$type)
working_df$class <- NA
working_df$class[working_df$type %in% c('AIS.1', 'AIS.3','AIS.5')] <- 'A'
working_df$class[working_df$type %in% c('AIS.18', 'AIS.19')] <- 'B'
working_df$class[working_df$type %in% c( 'AIS.4', 'AIS.9', 'AIS.17', 'AIS.11')] <- 'OTH'

# save information for 11 vessels that transmit different names 
class_df <- filter(working_df, ssvid %in% voi_that_transmit) %>% group_by(ssvid, year, month, class) %>% summarise(n=n())

# look at class usage for each of the 11 change identity
filter(working_df, ssvid %in% voi_that_transmit) %>% group_by(ssvid, class) %>% summarise(n=n(), first=min(timestamp), last=max(timestamp))

# examine the two vessels in class A and B from the research report 
# 150402951
View(working_df %>% filter(ssvid =='150402951', between(timestamp,as.POSIXct('2021-12-01'),as.POSIXct('2021-12-30')))%>% arrange(timestamp))
# 150402944
View(working_df %>% filter(ssvid =='150402944', between(timestamp,as.POSIXct('2021-12-01'),as.POSIXct('2021-12-30')))%>% arrange(timestamp))

# look at positional messages of x after 04 December
working_df %>% filter(ssvid =='150402944', timestamp >= as.POSIXct('2021-12-04'), type %in% c('AIS.3','AIS.19'))

```

```{r create bespoke df to investigate AIS message types, echo=F}

# query to get best name on a day
# q_top_six <- readr::read_file(file = here::here("queries", ".", "investigate_a_b.sql"))
# 
# # extract data
# data_a_b <- fishwatchr::gfw_query(query = q_top_six,
#                                  run_query = TRUE,
#                                  con = con)$data
# 
# data_a_b %>% saveRDS(here::here("data", ".", "voi_ab_2020_2023.rds"))

# read in the class A/B data 
data_a_b <- read_rds(here::here("data", ".", "voi_ab_2020_2023.rds"))

# look at usage for each MMSI
table(is.na(data_a_b$implied_speed_knots), data_a_b$ssvid)

# add year and month 
data_a_b <- data_a_b %>% mutate(month=month(timestamp), year=year(timestamp))


# look at time periods of class usage 
View(data_a_b %>% group_by(ssvid, AIS_class) %>% summarise(n=n(), first=min(timestamp), last=max(timestamp)))

# monthly changes in 412 vessels 
View(filter(data_a_b, str_detect(ssvid, '^412')) %>% group_by(ssvid, year, month, AIS_class) %>% summarise(n=n(), first=min(timestamp), last=max(timestamp)))


# seperate class A and class B
data_150402944_a <- data_a_b %>% filter(ssvid == '150402944', AIS_class == 'A')
data_150402944_b <- data_a_b %>% filter(ssvid == '150402944', AIS_class == 'B')
write.csv(data_150402944_a, here::here("data", ".", "150402944_a_2023.csv"))
write.csv(data_150402944_b, here::here("data", ".", "150402944_b_2023.csv"))


# seperate class A and class B
data_150402951_a <- data_a_b %>% filter(ssvid == '150402951', AIS_class == 'A')
data_150402951_b <- data_a_b %>% filter(ssvid == '150402951', AIS_class == 'B')
write.csv(data_150402951_a, here::here("data", ".", "150402951_a_2021_2023.csv"))
write.csv(data_150402951_b, here::here("data", ".", "150402951_b_2021_2023.csv"))

data_150402944
write.csv(filter(data_a_b,ssvid == '150402944', year =='2023'), here::here("data", ".", "150402944_2023.csv"))


voi_150402951 <- data_a_b %>% filter(ssvid == '150402951')
voi_150402951_toi <- filter(data_a_b, ssvid == '150402951', between(timestamp, as.POSIXct('2021-12-01'), as.POSIXct('2022-02-15'))) %>% arrange(timestamp)
write.csv(voi_150402951_toi, here::here("data", ".", "150402951_01dec2021_15feb2022.csv"))



table(is.na(voi_150402951$implied_speed_knots), voi_150402951$year)
table(voi_150402951$AIS_class, voi_150402951$year)
table(is.na(voi_150402951$implied_speed_knots), voi_150402951$AIS_class)
table(voi_150402951$year, voi_150402951$AIS_class)
quantile(voi_150402951$implied_speed_knots, na.rm=T)

look <- voi_150402951 %>% filter(implied_speed_knots>20)
look_na <- voi_150402951 %>% filter(is.na(implied_speed_knots))
write.csv(voi_150402951, here::here("data", ".", "voi_150402951_all.csv"))
write.csv(look, here::here("data", ".", "voi_150402951_high_implied.csv"))
write.csv(look_na, here::here("data", ".", "voi_150402951_na_implied.csv"))

voi_150402951_2021_a <- filter(voi_150402951, year== '2021', AIS_class == 'A')
voi_150402951_2021_b <- filter(voi_150402951, year== '2021', AIS_class == 'B')
write.csv(voi_150402951_2021_a, here::here("data", ".", "voi_150402951_2021_a.csv"))
write.csv(voi_150402951_2021_b, here::here("data", ".", "voi_150402951_2021_b.csv"))

```

```{r map of 150402944 activity, echo=F}
# segment analysis 
seg_summary <- data_a_b %>% 
    # filter(ssvid == '150402944') %>% 
      group_by(ssvid, seg_id) %>% 
        summarise(start_seg = min(timestamp),
                  end_seg = max(timestamp),
                  seg_length = difftime(end_seg, start_seg, units='days'), 
                  positions = n()) %>% 
            filter(positions >5) %>% 
              mutate(overlapping_seg = start_seg < lag(end_seg))

seg_summary_add <- filter(seg_summary, positions >5) %>% mutate(overlapping_seg = start_seg < lag(end_seg))
seg_summary_add$ndx <- seq(1, nrow(seg_summary_add), 1)

# identify overlapping segs
seg_ndx <- seg_summary_add %>% filter(overlapping_seg)

# identify segments before the overlapping segments too 
index <- c(seg_ndx$ndx, seg_ndx$ndx-1)

# save indexed df
df_voi <- seg_summary_add[sort(index),]

# remove duplicates 
df_voi_np <- df_voi[!duplicated(seg_summary_add[sort(index),]),]

# write out interesting segments
write.csv(df_voi_np, here::here("data", ".", "relevant_overlapping_segs_voi.csv"))

# 412334074 segments 
seg1 <- filter(data_a_b, seg_id=='412334074-2022-06-26T17:05:55.000000Z')
seg2 <- filter(data_a_b, seg_id=='412334074-2022-09-10T19:45:00.000000Z')

# write out interesting segments
write.csv(seg1, here::here("data", ".", "412334074_seg1.csv"))
write.csv(seg2, here::here("data", ".", "412334074_seg2.csv"))

# number of segments per vessel
table(seg_summary$ssvid, seg_summary$overlapping_seg)


write.csv(filter(data_a_b, seg_id %in% c('412334074-2022-04-19T16:59:48.000000Z','412334074-2021-12-05T03:43:08.080000Z')), here::here("data", ".", "overlapping_seg_check.csv"))
```

```{r map of 150402944 activity different res, echo=F}
# just 150402944
voi_150402944 <- data_a_b %>% filter(ssvid == '150402944') %>% arrange(timestamp)

# look for bitflips 
quantile(voi_150402944$implied_speed_knots, na.rm=T)
quantile(voi_150402944$meters_to_prev, na.rm=T)
quantile(voi_150402944$lat, na.rm=T)
View(voi_150402944 %>% filter(implied_speed_knots>20))
View(voi_150402944 %>% filter(is.na(implied_speed_knots)))
View(voi_150402944 %>% filter(meters_to_prev > 100000))

bitflip_ant <- filter(voi_150402944, lat < -60)
filter(voi_150402944, between(timestamp, as.POSIXct('2020-01-01'), as.POSIXct('2020-01-02'))) 
    as.difftime(2, unit="days")

View(filter(voi_150402944, between(timestamp, as.POSIXct('2021-07-28'), as.POSIXct('2021-12-01'))))
    
    
bitflip_ant$timestamp+day(1, )    
    
# centre 
new_center <- -80

# pull in name change locations 
recenter_changes_150402944 <- name_change_l %>% filter(ssvid == '150402944') %>%
  dplyr::select(timestamp, static_lat, static_lon) %>%
  sf::st_as_sf(., 
               coords = c("static_lon", "static_lat"), 
               crs = 4326) %>%
  # group_by(AIS_class) %>%
  arrange(timestamp) %>%
  summarize(do_union = FALSE) #%>%
  # sf::st_cast(., "LINESTRING") %>%
  # fishwatchr::recenter_sf(., center = new_center, buffer=0)

# make line string for plotting with track split to not include jump from China to Atlantic in late 2021 
# speed is possible for this movement. 
recenter_150402944_p1 <- voi_150402944 %>%
  filter(!is.na(lat), !is.na(implied_speed_knots), timestamp < as.POSIXct('2021-07-30')) %>%
  dplyr::select(timestamp, lat, lon) %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) %>%
  # group_by(AIS_class) %>%
  arrange(timestamp) %>%
  summarize(do_union = FALSE) %>%
  sf::st_cast(., "LINESTRING") %>%
  fishwatchr::recenter_sf(., center = new_center, buffer=0)

recenter_150402944_p2 <- voi_150402944 %>%
  filter(!is.na(lat), !is.na(implied_speed_knots), timestamp > as.POSIXct('2021-08-01')) %>%
  dplyr::select(timestamp, lat, lon) %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) %>%
  # group_by(AIS_class) %>%
  arrange(timestamp) %>%
  summarize(do_union = FALSE) %>%
  sf::st_cast(., "LINESTRING") %>%
  fishwatchr::recenter_sf(., center = new_center, buffer=0)

# make name pattern coloured map 
ggplot() +
  geom_gfw_outline(center = new_center, 
                   theme = "dark") +
  geom_gfw_land(center = new_center) +
  geom_sf(data = recenter_150402944_p1, colour=gfw_palettes$primary[2]) +
  geom_sf(data = recenter_150402944_p2, colour=gfw_palettes$primary[2]) +
  geom_sf(data = recenter_changes_150402944, colour=gfw_palettes$primary[1] ) +
  geom_gfw_eez(theme = 'dark', center = new_center, alpha = 0.30) +
 # scale_colour_manual(values = gfw_palettes$primary) +
  theme_gfw_map(theme = "light") +
  theme(legend.position="bottom") +
  labs(colour = 'AIS class') 

```

```{r area where we see two vessels transmitting, echo=F, warning=F}
# add day to count values 
voi_150402944$day <- day(voi_150402944$timestamp)

# set focal date periods 
date_start <- as.POSIXct('2023-01-30')
date_end <- as.POSIXct('2023-02-08')

# examine data in period of interest 
voi_150402944 %>% filter(between(timestamp, date_start, date_end)) %>%  
              group_by(AIS_class) %>% 
                summarise(days = n_distinct(day), transmissions = n(), start = min(timestamp), end = max(timestamp))

# set dfs for plotting 
voi_150402944_t <- voi_150402944 %>% filter(between(timestamp, date_start, date_end))
test <- filter(voi_150402944_t, implied_speed_knots>20)
quantile(voi_150402944_t$implied_speed_knots, na.rm=T)

new_center <- -60

# set proj for bounding box
best_proj <- "+proj=eqearth +lon_0=-60 +wktext"

# set plot limits for high res Atlantic map  
bounding_atlantic <- transform_box(xlim = c(-60, -61),
                          ylim = c(-44.75, -46),
                          output_crs = 4326)

# make st object of identity points
recenter_150402944_t <- voi_150402944_t %>%
  dplyr::select(AIS_class, timestamp, lat, lon) %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) %>%
  group_by(AIS_class) %>%
  arrange(timestamp) %>%
  summarize(do_union = FALSE) %>%
  sf::st_cast(., "LINESTRING") %>%
  fishwatchr::recenter_sf(., center = new_center, buffer=0)

recenter_150402944_t_trans <- st_transform(recenter_150402944_t, crs=4326)

name_change_df <- data.frame(name=c('LURONGYUANYU601', 'FUYUANYU9993', 'LURONGYUANYU601','FUYUANYU9993', 'LUWENYUANGYU601', 'FUYUANYU9993', 'LURONGYUANYU277'), 
           lat=c(-45.50525, -45.52593,-45.52582333,-45.52577,-45.121805, -45.12711, -45.681345), 
           lon=c(-60.53172833,-60.42465667,-60.42413333,-60.42350667, -60.15686667, -60.19026, -59.86237667), 
           timestamp=c('02/02/2023  21:08:03', '03/02/2023  01:34:44', '03/02/2023  03:00:20', 
                       '03/02/2023  05:01:41', '04/02/2023  04:28:30', '04/02/2023  10:33:21', '14/02/2023  04:15:55'))

# make st object of identity points
name_change_points <- name_change_df %>%
# name_change_points <- test %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) 

# reproject identity points object 
name_change_points_trans <- st_transform(name_change_points, crs=4326)

# map out the data 
map_dif <- ggplot() +
  geom_gfw_land(theme = 'light', proj = gfw_projections("Equal Earth")$proj) +
  geom_gfw_eez(proj = gfw_projections("Equal Earth")$proj, colour='black') +
  geom_sf(data = recenter_150402944_t_trans, aes(colour=AIS_class)) +
  geom_sf(data = name_change_points_trans, colour='black') +
  # geom_sf_label(data = name_change_points_trans, aes(label = name), color = "black", size = 4)+
  scale_colour_manual(values = gfw_palettes$primary) +
  theme_gfw_map(theme = "light") +
  theme(legend.position="right") +
  labs(colour = 'AIS class') +
  coord_sf(xlim = c(bounding_atlantic$box_out[['xmin']], bounding_atlantic$box_out[['xmax']]),
           ylim = c(bounding_atlantic$box_out[['ymin']], bounding_atlantic$box_out[['ymax']]),
           crs = bounding_atlantic$out_crs)


# ts_plot_df <- voi_150402944_t %>%
#     group_by(AIS_class) %>% 
#   dplyr::mutate(next_time = dplyr::lead(timestamp),
#                 time_diff_hr = as.numeric(difftime(next_time,
#                                                    timestamp,
#                                                    tz = 'UTC',
#                                                    units = 'sec'))/3600,
#                 next_far = ifelse(time_diff_hr > 3, TRUE, FALSE),
#                 prev_far = ifelse(lead(next_far) == TRUE, TRUE, FALSE),
#                 AIS_class_m = as.character(ifelse(next_far == TRUE | prev_far == TRUE, NA , AIS_class)),
#                 slow_speed = ifelse(speed_knots<5, TRUE, FALSE))
# 
# # make the line plot coloured by speed
# line_geom <-
#   geom_path(data = ts_plot_df,
#             aes(x= timestamp,
#                 #eval(as.symbol(speed_knots)),
#                 y= speed_knots,
#                 color = AIS_class,
#                 group  = AIS_class))
# # set colours 
# line_colorscale <-
#   scale_color_manual('',
#                      # breaks = c(FALSE,TRUE),
#                      values = c('#E34D4E',
#                                 '#76ADAD',
#                                 'grey85'))
#                      # labels = NULL)
#                      #labels = c('>5 knots','< 5 knots'))
# 
# # time series plot of speed
# time_series_plot <- ggplot() +
#   line_geom +
#   # point_geom +
#   # line_sizescale +
#   line_colorscale +
#   #y_axis +
#   scale_x_datetime('\nDate') +
#   fishwatchr::theme_gfw() +
#   theme(
#         legend.position = 'none',
#         legend.justification = 'right',
#         panel.grid.minor = element_blank(),
#         panel.grid.major.y = element_blank(),
#         panel.background = element_rect(fill = '#ffffff'),
#         panel.border = element_rect(fill = NA, color = '#000000'),
#         plot.background = element_rect(fill = '#ffffff'))+
#         # axis.text.x = element_blank(),
#         # axis.title.x = element_blank()) +
#   labs(y='Speed (knots)')

## putt plots together in stacked display

# num_components <- 1
# page_layout <- patchwork::plot_layout(ncol = 1,
#                                       widths = c(1.5,1),
#                                       heights = c(1 - 0.2, 0.2),
#                                       guides = 'auto')
#                                       # guides = 'keep')
# 
# # arrange plots on page
# fishwatchr::add_little_globe(map_dif,
#                              main_box = bounding_atlantic,
#                              globe_rel_size = '0.25',
#                              globe_just = 'inside',
#                              globe_position = 'upperright') +
#     time_series_plot +
#     page_layout

map_dif + annotation_scale(location = "br", width_hint=0.25)

map_dif + ggsn::scalebar(x.min = bounding_atlantic$box_out[['xmin']], 
                 x.max = bounding_atlantic$box_out[['xmax']], 
                 y.min = bounding_atlantic$box_out[['ymin']], 
                 y.max = bounding_atlantic$box_out[['ymax']],
                 model = "WGS84",  
                 dist_unit = "nm", 
                 transform = TRUE,
                 location = "bottomleft",
                 height = 0.02, 
                 dist = 5, 
                 st.size = 3, 
                 border.size = 0.4)


ggsave(here::here("outputs", "figures", "Atlantic_highres_150402944_01_09Jun2023.png"))


```

```{r 18 July 2022 example, echo=F, warning=F}

voi_150402944 <- data_a_b %>% filter(ssvid == '150402944') %>% arrange(timestamp)

# add day to count values 
voi_150402944$day <- day(voi_150402944$timestamp)

# set focal date periods 
date_start <- as.POSIXct('2022-07-18')
date_end <- as.POSIXct('2022-07-19')

# set dfs for plotting 
voi_150402944_t <-voi_150402944 %>% filter(between(timestamp, date_start, date_end))
#write.csv(voi_150402944_t, here::here("data", ".", "150402944_18Jul2022.csv"))

new_center <- -60

# set proj for bounding box
# best_proj <- "+proj=eqearth +lon_0=-60 +wktext"
best_proj <- 4326

# set plot limits for high res Atlantic map  
bounding_atlantic <- transform_box(xlim = c(-58.2, -60),
                          ylim = c(-44.4, -45.5),
                          output_crs = best_proj)

# make st object of identity points
recenter_150402944_t <- voi_150402944_t %>%
  dplyr::select(timestamp, lat, lon) %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) %>%
  arrange(timestamp) %>%
  summarize(do_union = FALSE) %>%
  sf::st_cast(., "LINESTRING") %>%
  fishwatchr::recenter_sf(., center = new_center, buffer=0)

recenter_150402944_t_trans <- st_transform(recenter_150402944_t, crs=best_proj)

# make st object of identity points
name_change_points <- voi_150402944_t %>%
    dplyr::select(AIS_class, timestamp, lat, lon) %>%
  sf::st_as_sf(., 
               coords = c("lon", "lat"), 
               crs = 4326) %>%
  group_by(AIS_class) %>%
  arrange(timestamp) %>%
  summarize(do_union = FALSE) %>%
  sf::st_cast(., "POINT") %>%
  fishwatchr::recenter_sf(., center = new_center, buffer=0)

# reproject identity points object 
name_change_points_trans <- st_transform(name_change_points, crs=4326)

# map out the data 
map_dif <- ggplot() +
  geom_gfw_land(theme = 'light', proj = gfw_projections("Equal Earth")$proj) +
  geom_gfw_eez(proj = gfw_projections("Equal Earth")$proj, colour='black') +
  geom_sf(data = recenter_150402944_t_trans, colour='black') +
  geom_sf(data = name_change_points_trans, aes(colour=AIS_class)) +
  # geom_sf_label(data = name_change_points_trans, aes(label = name), color = "black", size = 4)+
  scale_colour_manual(values = gfw_palettes$primary) +
  theme_gfw_map(theme = "light") +
  theme(legend.position="right") +
  labs(colour = 'AIS class') +
  coord_sf(xlim = c(bounding_atlantic$box_out[['xmin']], bounding_atlantic$box_out[['xmax']]),
           ylim = c(bounding_atlantic$box_out[['ymin']], bounding_atlantic$box_out[['ymax']]),
           crs = bounding_atlantic$out_crs)

map_dif + ggsn::scalebar(x.min = bounding_atlantic$box_out[['xmin']], 
                                               x.max = bounding_atlantic$box_out[['xmax']], 
                                               y.min = bounding_atlantic$box_out[['ymin']], 
                                               y.max = bounding_atlantic$box_out[['ymax']],
                                               model = "WGS84",  
                                               dist_unit = "nm", 
                                               transform = TRUE,
                                               location = "bottomleft",
                                               height = 0.02, 
                                               dist = 5, 
                                               st.size = 3, 
                                               border.size = 0.4)



ggsave(here::here("outputs", "figures", "Atlantic_highres_150402944_18Jul2022_v2.png"))
```

```{r 18 July 2022 example time series, echo=F, warning=F}
voi_150402944_t

# make the line plot coloured by speed
line_geom <-
  geom_path(data = voi_150402944_t,
            aes(x= timestamp,
                #eval(as.symbol(speed_knots)),
                y= meters_to_prev,
                color = AIS_class,
                group  = AIS_class))
# set colours 
line_colorscale <-
  scale_color_manual('',
                     # breaks = c(FALSE,TRUE),
                     values = c('#E34D4E',
                                '#76ADAD',
                                'grey85'))
                     # labels = NULL)
                     #labels = c('>5 knots','< 5 knots'))

# time series plot of speed
time_series_plot <- ggplot() +
  line_geom +
  # point_geom +
  # line_sizescale +
  line_colorscale +
  #y_axis +
  scale_x_datetime('\nDate') +
  fishwatchr::theme_gfw() +
  theme(
        legend.position = 'none',
        legend.justification = 'right',
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.background = element_rect(fill = '#ffffff'),
        panel.border = element_rect(fill = NA, color = '#000000'),
        plot.background = element_rect(fill = '#ffffff'))+
        # axis.text.x = element_blank(),
        # axis.title.x = element_blank()) +
  labs(y='Meters to previous')


ggsave(here::here("outputs", "figures", "timeseries_150402944_18Feb2023.png"))


```


# Annex 

```{r Creating annex tables from Els dataset, echo=FALSE}
# read in annex tables 
# sourced from https://docs.google.com/spreadsheets/d/1B4zpKF9RKlvmRZU4EMTsJnqcA4PBhUtg/edit?usp=sharing&ouid=101477854774495795304&rtpof=true&sd=true tabs Names2 & Names3
annex1 <- read.csv(here::here("data", ".", "150_voi_annex_table1_input.csv"))
annex2 <- read.csv(here::here("data", ".", "150_voi_annex_table2_input.csv"))

#restore old ssvid label
colnames(annex2)[1] <- 'ssvid'

# drop extra columns 
annex1_m <- annex1 %>% dplyr::select(-Known.Chinese.vessel, -imo, -Unknown.Chinese.vessel,
                  -Non.Chinese.vessel.name, -Owner, -MMSI.count)

# remove leading X
colnames(annex1_m)[-1] <- sub('.', '', colnames(annex1_m)[-1])

# add colnames to string where true 
test <- annex1_m %>% 
   pivot_longer(cols = -vessel_name) %>% 
   group_by(vessel_name) %>% 
   summarise(mmsi = toString(name[as.logical(value)])) #%>% 
   #right_join(annex1_m) %>%
   #select(names(annex1_m), everything())

# add interesting columns 
plot_df <-  left_join(test[-1,], dplyr::select(annex1, vessel_name, Owner, imo))

# write out annex table 1
write.csv(dplyr::select(plot_df, vessel_name, imo, Owner, mmsi), here::here("data", ".", "150_voi_annex_t1_formated.csv"))


# drop extra columns 
annex2_m <- annex2[annex2$'Name.count'>1,] %>% dplyr::select(-Transmissions, -Name.count)

# add colnames to string where true 
test2 <- annex2_m %>% 
   pivot_longer(cols = -ssvid) %>% 
   group_by(ssvid) %>% 
   summarise(mmsi = toString(name[as.logical(value)])) #%>% 
   #right_join(annex1_m) %>%
   #select(names(annex1_m), everything())

# write out annex table 2
write.csv(test2, here::here("data", ".", "150_voi_annex_t2_formated.csv"))

annex3_m <- annex2[annex2$'Name.count'==1,] %>% dplyr::select(-Transmissions, -Name.count)

# add colnames to string where true 
test3 <- annex3_m %>% 
   pivot_longer(cols = -ssvid) %>% 
   group_by(ssvid) %>% 
   summarise(mmsi = toString(name[as.logical(value)])) #%>% 
   #right_join(annex1_m) %>%
   #select(names(annex1_m), everything())

# bind on transmissions to reformated table 
test3_trans <- left_join(test3, dplyr::select(annex2[annex2$'Name.count'==1,], ssvid, Transmissions))

#filter out non 15040 
annex_3_final <- test3_trans %>% filter(stringr::str_detect(test3_trans$ssvid, '^1504'))

# write out annex table 3
write.csv(annex_3_final, here::here("data", ".", "150_voi_annex_t3_formated.csv"))
```

# Activity in Chinese designated closure area 

Check for activity within the closure location 32°S-44°S, 48°W-60°W and period July to September
```{r Activity in Chinese designated closure area, echo=F, warning=F}
# get data in closure peirod
closure_period <- filter(working_df, month %in% c(7,8,9))

# filter data to within closure location
closure_location <- filter(closure_period, between(lon, -60, -48), between(lat, -44, -32))
# no data

# test filter with full df 
test <- filter(working_df, between(lon, -60, -48), between(lat,-44,-32))

# map data in closure period to cross check 
res <- 0.1
closure_period$lat_bin <- round(closure_period$lat / res) * res
closure_period$lon_bin <- round(closure_period$lon / res) * res

Poly_Coord_df = data.frame(lon=c(-60, -48), lat=c(-44,-32))

poly <- Poly_Coord_df %>% 
  st_as_sf(coords = c('lon', 'lat'), 
           crs = 4326) %>% 
  st_bbox() %>% 
  st_as_sfc()


# count positions in each lat lon bin
presence <- closure_period %>%
  group_by(lat_bin, lon_bin) %>%
    summarise(
      positions = dplyr::n(), 
    )

# set upper limit
up_lim <- 10000 
#set plot center 
new_center <- -60


# set proj for bounding box
best_proj <- "+proj=eqearth +lon_0=-60 +wktext"

# set plot limits for Pacific 
bounding_atlantic <- transform_box(xlim = c(-70, -50),
                          ylim = c(-35, -55),
                          output_crs = best_proj)
  
atlantic_map <- presence %>%
  recenter_raster(raster_df = .,
                  res = 1,
                  x_lab = 'lon_bin',
                  y_lab = 'lat_bin',
                  fill_lab = 'positions',
                  center = new_center) %>% 
  ggplot()+
  geom_gfw_outline(center = new_center, theme = "dark") +
  geom_raster(aes(x= lon_bin, y=lat_bin, fill = positions)) +
    geom_gfw_eez(theme = 'dark', alpha = 0.4, center = new_center) +
    geom_gfw_land(theme = 'dark', center = new_center) +
    geom_sf(data=poly, fill=NA, colour='red')+
    scale_fill_gradientn(colors = gfw_palette('map_effort_dark'),
                       #limits = c(0,up_lim),
                       oob = scales::squish,
                       na.value = NA) +   
    coord_sf(xlim = c(bounding_atlantic$box_out[['xmin']], bounding_atlantic$box_out[['xmax']]),
           ylim = c(bounding_atlantic$box_out[['ymin']], bounding_atlantic$box_out[['ymax']]),
           crs = bounding_atlantic$out_crs) +
      labs(fill = 'AIS Positions') +
      theme_gfw_map(theme = 'light') 


fishwatchr::add_little_globe(atlantic_map,
                             main_box = bounding_atlantic,
                             globe_rel_size = '0.25',
                             globe_just = 'inside',
                             globe_position = 'upperleft')  
 
```
